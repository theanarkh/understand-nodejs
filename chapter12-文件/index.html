<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="通过源码分析 Node.js 原理"><meta name=author content=theanarkh><link href=https://github.com/theanarkh/understand-nodejs/chapter12-%E6%96%87%E4%BB%B6/ rel=canonical><link href=../chapter11-setImmediate%E5%92%8CnextTick/ rel=prev><link href=../chapter13-%E8%BF%9B%E7%A8%8B/ rel=next><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.44"><title>12-文件 - Node.js 源码剖析</title><link rel=stylesheet href=../assets/stylesheets/main.0253249f.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#121-api class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=.. title="Node.js 源码剖析" class="md-header__button md-logo" aria-label="Node.js 源码剖析" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Node.js 源码剖析 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 12-文件 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/theanarkh/understand-nodejs title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> understand-nodejs </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../chapter00-%E5%89%8D%E8%A8%80/ class=md-tabs__link> 前言 </a> </li> <li class=md-tabs__item> <a href=../chapter01-Node.js%E7%BB%84%E6%88%90%E5%92%8C%E5%8E%9F%E7%90%86/ class=md-tabs__link> Node.js基础和架构 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../chapter07-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/ class=md-tabs__link> Node.js核心模块的实现 </a> </li> <li class=md-tabs__item> <a href=../chapter20-%E6%8B%93%E5%B1%95Node.js/ class=md-tabs__link> 其他 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Node.js 源码剖析" class="md-nav__button md-logo" aria-label="Node.js 源码剖析" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg> </a> Node.js 源码剖析 </label> <div class=md-nav__source> <a href=https://github.com/theanarkh/understand-nodejs title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> understand-nodejs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../chapter00-%E5%89%8D%E8%A8%80/ class=md-nav__link> <span class=md-ellipsis> 前言 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Node.js基础和架构 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Node.js基础和架构 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter01-Node.js%E7%BB%84%E6%88%90%E5%92%8C%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 01-Node.js组成和原理 </span> </a> </li> <li class=md-nav__item> <a href=../chapter02-Libuv%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E9%80%9A%E7%94%A8%E9%80%BB%E8%BE%91/ class=md-nav__link> <span class=md-ellipsis> 02-Libuv数据结构和通用逻辑 </span> </a> </li> <li class=md-nav__item> <a href=../chapter03-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/ class=md-nav__link> <span class=md-ellipsis> 03-事件循环 </span> </a> </li> <li class=md-nav__item> <a href=../chapter04-%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> <span class=md-ellipsis> 04-线程池 </span> </a> </li> <li class=md-nav__item> <a href=../chapter05-Libuv%E6%B5%81/ class=md-nav__link> <span class=md-ellipsis> 05-Libuv流 </span> </a> </li> <li class=md-nav__item> <a href=../chapter06-C%2B%2B%E5%B1%82/ class=md-nav__link> <span class=md-ellipsis> 06-C++层 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Node.js核心模块的实现 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Node.js核心模块的实现 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter07-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 07-信号处理 </span> </a> </li> <li class=md-nav__item> <a href=../chapter08-DNS/ class=md-nav__link> <span class=md-ellipsis> 08-DNS </span> </a> </li> <li class=md-nav__item> <a href=../chapter09-Unix%E5%9F%9F/ class=md-nav__link> <span class=md-ellipsis> 09-Unix域 </span> </a> </li> <li class=md-nav__item> <a href=../chapter10-%E5%AE%9A%E6%97%B6%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> 10-定时器 </span> </a> </li> <li class=md-nav__item> <a href=../chapter11-setImmediate%E5%92%8CnextTick/ class=md-nav__link> <span class=md-ellipsis> 11-setImmediate和nextTick </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 12-文件 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 12-文件 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#121-api class=md-nav__link> <span class=md-ellipsis> 12.1 同步API </span> </a> </li> <li class=md-nav__item> <a href=#122-api class=md-nav__link> <span class=md-ellipsis> 12.2 异步API </span> </a> </li> <li class=md-nav__item> <a href=#123 class=md-nav__link> <span class=md-ellipsis> 12.3 文件监听 </span> </a> <nav class=md-nav aria-label="12.3 文件监听"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1231 class=md-nav__link> <span class=md-ellipsis> 12.3.1 基于轮询的文件监听机制 </span> </a> </li> <li class=md-nav__item> <a href=#1232inotify class=md-nav__link> <span class=md-ellipsis> 12.3.2基于inotify的文件监听机制 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#124-promiseapi class=md-nav__link> <span class=md-ellipsis> 12.4 Promise化API </span> </a> </li> <li class=md-nav__item> <a href=#125-api class=md-nav__link> <span class=md-ellipsis> 12.5 流式API </span> </a> <nav class=md-nav aria-label="12.5 流式API"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1251 class=md-nav__link> <span class=md-ellipsis> 12.5.1 可读文件流 </span> </a> </li> <li class=md-nav__item> <a href=#1252 class=md-nav__link> <span class=md-ellipsis> 12.5.2 可写文件流 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../chapter13-%E8%BF%9B%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 13-进程 </span> </a> </li> <li class=md-nav__item> <a href=../chapter14-%E7%BA%BF%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 14-线程 </span> </a> </li> <li class=md-nav__item> <a href=../chapter15-Cluster/ class=md-nav__link> <span class=md-ellipsis> 15-Cluster </span> </a> </li> <li class=md-nav__item> <a href=../chapter16-UDP/ class=md-nav__link> <span class=md-ellipsis> 16-UDP </span> </a> </li> <li class=md-nav__item> <a href=../chapter17-TCP/ class=md-nav__link> <span class=md-ellipsis> 17-TCP </span> </a> </li> <li class=md-nav__item> <a href=../chapter18-HTTP/ class=md-nav__link> <span class=md-ellipsis> 18-HTTP </span> </a> </li> <li class=md-nav__item> <a href=../chapter19-%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> 19-模块加载 </span> </a> </li> <li class=md-nav__item> <a href=../chapter21-JS%20Stream/ class=md-nav__link> <span class=md-ellipsis> 20-JS Stream </span> </a> </li> <li class=md-nav__item> <a href=../chapter22-events%E6%A8%A1%E5%9D%97/ class=md-nav__link> <span class=md-ellipsis> 21-events模块 </span> </a> </li> <li class=md-nav__item> <a href=../chapter23-Async%20hooks/ class=md-nav__link> <span class=md-ellipsis> 22-Async hooks </span> </a> </li> <li class=md-nav__item> <a href=../chapter24-Inspector/ class=md-nav__link> <span class=md-ellipsis> 23-Inspector </span> </a> </li> <li class=md-nav__item> <a href=../chapter27-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Node.js%20%E7%9A%84%20Buffer/ class=md-nav__link> <span class=md-ellipsis> 27-深入理解 Node.js 的 Buffer </span> </a> </li> <li class=md-nav__item> <a href=../chapter30-Node.js%20%E7%9A%84%20trace%20events%20%E6%9E%B6%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 30-Node.js 的 trace events 架构 </span> </a> </li> <li class=md-nav__item> <a href=../chapter31-Node.js%20%E7%9A%84%20perf_hooks/ class=md-nav__link> <span class=md-ellipsis> 31-Node.js 的 perf_hooks </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter20-%E6%8B%93%E5%B1%95Node.js/ class=md-nav__link> <span class=md-ellipsis> 24-拓展Node.js </span> </a> </li> <li class=md-nav__item> <a href=../chapter25-Node.js子线程调试和诊断指南 class=md-nav__link> <span class=md-ellipsis> 25-Node.js子线程调试和诊断指南 </span> </a> </li> <li class=md-nav__item> <a href=../chapter26-vscode%E8%B0%83%E8%AF%95Node.js/ class=md-nav__link> <span class=md-ellipsis> 26-vscode调试Node.js </span> </a> </li> <li class=md-nav__item> <a href=../chapter28-Node.js%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88%E6%9E%B6%E6%9E%84%E7%AF%87%EF%BC%89/ class=md-nav__link> <span class=md-ellipsis> 28-Node.js底层原理（架构篇） </span> </a> </li> <li class=md-nav__item> <a href=../chapter29-Node.js%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88%E5%AE%9E%E7%8E%B0%E7%AF%87%EF%BC%89/ class=md-nav__link> <span class=md-ellipsis> 29-Node.js底层原理（实现篇） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#121-api class=md-nav__link> <span class=md-ellipsis> 12.1 同步API </span> </a> </li> <li class=md-nav__item> <a href=#122-api class=md-nav__link> <span class=md-ellipsis> 12.2 异步API </span> </a> </li> <li class=md-nav__item> <a href=#123 class=md-nav__link> <span class=md-ellipsis> 12.3 文件监听 </span> </a> <nav class=md-nav aria-label="12.3 文件监听"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1231 class=md-nav__link> <span class=md-ellipsis> 12.3.1 基于轮询的文件监听机制 </span> </a> </li> <li class=md-nav__item> <a href=#1232inotify class=md-nav__link> <span class=md-ellipsis> 12.3.2基于inotify的文件监听机制 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#124-promiseapi class=md-nav__link> <span class=md-ellipsis> 12.4 Promise化API </span> </a> </li> <li class=md-nav__item> <a href=#125-api class=md-nav__link> <span class=md-ellipsis> 12.5 流式API </span> </a> <nav class=md-nav aria-label="12.5 流式API"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1251 class=md-nav__link> <span class=md-ellipsis> 12.5.1 可读文件流 </span> </a> </li> <li class=md-nav__item> <a href=#1252 class=md-nav__link> <span class=md-ellipsis> 12.5.2 可写文件流 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>12-文件</h1> <p>文件操作是我们使用Node.js时经常会用到的功能。Node.js中，文件模块的API几乎都提供了同步和异步的版本。同步的API直接在主线程中调用操作系统提供的接口，它会导致主线程阻塞。异步API则是在Libuv提供的线程池中执行阻塞式API实现的。这样就不会导致主线程阻塞。文件IO不同于网络IO，文件IO由于兼容性问题，无法像网络IO一样利用操作系统提供的能力直接实现异步。在Libuv中，文件操作是以线程池实现的，操作文件的时候，会阻塞在某个线程。所以这种异步只是对用户而言。文件模块虽然提供的接口非常多，源码也几千行，但是很多逻辑都是类似的，所以我们只讲解不同的地方。介绍文件模块之前先介绍一下Linux操作系统中的文件。</p> <p>Linux系统中万物皆文件，从应用层来看，我们拿到都是一个文件描述符，我们操作的也是这个文件描述符。使用起来非常简单，那是因为操作系统帮我们做了很多事情。简单来说，文件描述符只是一个索引。它的底层可以对应各种各样的资源，包括普通文件，网络，内存等。当我们操作一个资源之前，我们首先会调用操作系统的接口拿到一个文件描述符，操作系统也记录了这个文件描述符底层对应的资源、属性、操作函数等。当我们后续操作这个文件描述符的时候，操作系统就会执行对应的操作。比如我们在write的时候，传的文件描述符是普通文件和网络socket，底层所做的操作是不一样的。但是我们一般不需要关注这些。我们只需要从抽象的角度去使用它。本章介绍Node.js中关于文件模块的原理和实现。</p> <h2 id=121-api>12.1 同步API<a class=headerlink href=#121-api title="Permanent link">&para;</a></h2> <p>在Node.js中，同步API的本质是直接在主线程里调用操作系统提供的系统调用。下面以readFileSync为例，看一下整体的流程，如图12-1所示。<br> <img alt src="https://img-blog.csdnimg.cn/30843926b91a40f28cf763d9b0656e74.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"><br> 图12-1</p> <p>下面我们看一下具体的代码</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>readFileSync</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getOptions</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>flag</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=w> </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 传的是fd还是文件路径  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>isUserFd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>isFd</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span><span class=w>   </span>
<span class=w>      </span><span class=c1>// 传的是路径，则先同步打开文件  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>isUserFd</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>path</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>openSync</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>flag</span><span class=p>,</span><span class=w> </span><span class=mo>0o666</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 查看文件的stat信息，拿到文件的大小  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>stats</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>tryStatSync</span><span class=p>(</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>isUserFd</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 是否是一般文件  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>isFileType</span><span class=p>(</span><span class=nx>stats</span><span class=p>,</span><span class=w> </span><span class=nx>S_IFREG</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>stats</span><span class=p>[</span><span class=mf>8</span><span class=p>]</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>buffer</span><span class=p>;</span><span class=w> </span>
<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>buffers</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 文件大小是0或者不是一般文件，size则为0  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>size</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>buffers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[];</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 一般文件且有大小，则分配一个大小为size的buffer，size需要小于2G  </span>
<span class=w>        </span><span class=nx>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>tryCreateBuffer</span><span class=p>(</span><span class=nx>size</span><span class=p>,</span><span class=w> </span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>isUserFd</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 不断地同步读文件内容  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>size</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=nx>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>tryReadSync</span><span class=p>(</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>isUserFd</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=p>,</span><span class=w> </span><span class=nx>pos</span><span class=p>,</span><span class=w> </span><span class=nx>size</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>pos</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=nx>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=mf>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>pos</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nx>size</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=cm>/* </span>
<span class=cm>            文件大小为0，或者不是一般文件，也尝试去读， </span>
<span class=cm>            但是因为不知道大小，所以只能分配一个一定大小的buffer, </span>
<span class=cm>            每次读取一定大小的内容 </span>
<span class=cm>          */</span><span class=w>  </span>
<span class=w>          </span><span class=nx>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=nx>allocUnsafe</span><span class=p>(</span><span class=mf>8192</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=nx>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>tryReadSync</span><span class=p>(</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>isUserFd</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>8192</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 把读取到的内容放到buffers里  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=nx>buffers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>buffer</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>));</span><span class=w>  </span>
<span class=w>          </span><span class=p>}</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 记录读取到的数据长度  </span>
<span class=w>          </span><span class=nx>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=mf>0</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 用户传的是文件路径，Node.js自己打开了文件，所以需要自己关闭  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>isUserFd</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=nx>fs</span><span class=p>.</span><span class=nx>closeSync</span><span class=p>(</span><span class=nx>fd</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 文件大小是0或者非一般文件的话，如果读到了内容  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>size</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 把读取到的所有内容放到buffer中  </span>
<span class=w>        </span><span class=nx>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span><span class=nx>buffers</span><span class=p>,</span><span class=w> </span><span class=nx>pos</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>pos</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nx>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>buffer</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>pos</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 编码</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>)</span><span class=w> </span><span class=nx>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>buffer</span><span class=p>.</span><span class=nx>toString</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>buffer</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>tryReadSync调用的是fs.readSync，然后到binding.read(node_file.cc中定义的Read函数)。Read函数主要逻辑如下</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=n>FSReqWrapSync</span><span class=w> </span><span class=n>req_wrap_sync</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SyncCall</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span>
<span class=w>                                       </span><span class=n>args</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span><span class=w> </span>
<span class=w>                                       </span><span class=o>&amp;</span><span class=n>req_wrap_sync</span><span class=p>,</span><span class=w> </span>
<span class=w>                                       </span><span class=s>&quot;read&quot;</span><span class=p>,</span>
<span class=w>                                       </span><span class=n>uv_fs_read</span><span class=p>,</span><span class=w> </span>
<span class=w>                                       </span><span class=n>fd</span><span class=p>,</span><span class=w> </span>
<span class=w>                                       </span><span class=o>&amp;</span><span class=n>uvbuf</span><span class=p>,</span><span class=w> </span>
<span class=w>                                       </span><span class=mi>1</span><span class=p>,</span><span class=w> </span>
<span class=w>                                       </span><span class=n>pos</span><span class=p>);</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>我们看一下SyncCall的实现</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>SyncCall</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span>
<span class=w>                  </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w>  </span>
<span class=w>           </span><span class=n>FSReqWrapSync</span><span class=o>*</span><span class=w> </span><span class=n>req_wrap</span><span class=p>,</span><span class=w> </span>
<span class=w>                  </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>syscall</span><span class=p>,</span><span class=w>  </span>
<span class=w>           </span><span class=n>Func</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w> </span>
<span class=w>                  </span><span class=n>Args</span><span class=p>...</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/*</span>
<span class=cm>         req_wrap-&gt;req是一个uv_fs_t结构体，属于request类，</span>
<span class=cm>          管理一次文件操作的请求  </span>
<span class=cm>        */</span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fn</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>event_loop</span><span class=p>(),</span><span class=w> </span>
<span class=w>                        </span><span class=o>&amp;</span><span class=p>(</span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>req</span><span class=p>),</span><span class=w> </span>
<span class=w>                        </span><span class=n>args</span><span class=p>...,</span><span class=w> </span>
<span class=w>                        </span><span class=k>nullptr</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 忽略出错处理</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>我们看到最终调用的是Libuv的uv_fs_read，并使用uv_fs_t管理本次请求。因为是阻塞式调用，所以Libuv会直接调用操作系统的系统调用read函数。这是Node.js中同步API的过程。 </p> <h2 id=122-api>12.2 异步API<a class=headerlink href=#122-api title="Permanent link">&para;</a></h2> <p>文件系统的API中，异步的实现是依赖于Libuv的线程池的。Node.js把任务放到线程池，然后返回主线程继续处理其它事情，等到条件满足时，就会执行回调。我们以readFile为例讲解这个过程。异步读取文件的流程图，如图12-2所示。<br> <img alt src="https://img-blog.csdnimg.cn/e85ea13f393c4e93aaa43f02512dab91.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"><br> 图12-2</p> <p>下面我们看具体的实现</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>readFile</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=nx>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>callback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>maybeCallback</span><span class=p>(</span><span class=nx>callback</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getOptions</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>flag</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=w> </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 管理文件读的对象  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>ReadFileContext</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=nx>ReadFileContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;internal/fs/read_file_context&#39;</span><span class=p>);</span><span class=w> </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>ReadFileContext</span><span class=p>(</span><span class=nx>callback</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>)</span>
<span class=w>      </span><span class=c1>// 传的是文件路径还是fd  </span>
<span class=w>      </span><span class=nx>context</span><span class=p>.</span><span class=nx>isUserFd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>isFd</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span><span class=w> </span><span class=c1>// File descriptor ownership  </span>
<span class=w>      </span><span class=c1>// C++层的对象，封装了uv_fs_t结构体，管理一次文件读请求  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>FSReqCallback</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=nx>req</span><span class=p>.</span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>context</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 设置回调，打开文件后，执行  </span>
<span class=w>      </span><span class=nx>req</span><span class=p>.</span><span class=nx>oncomplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>readFileAfterOpen</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 传的是fd，则不需要打开文件，下一个tick直接执行回调读取文件  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>isUserFd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>process</span><span class=p>.</span><span class=nx>nextTick</span><span class=p>(</span><span class=kd>function</span><span class=w> </span><span class=nx>tick</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=nx>req</span><span class=p>.</span><span class=nx>oncomplete</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=nx>path</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>});</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=nx>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getValidatedPath</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>flagsNumber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>stringToFlags</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>flags</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 调用C++层open打开文件  </span>
<span class=w>      </span><span class=nx>binding</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>pathModule</span><span class=p>.</span><span class=nx>toNamespacedPath</span><span class=p>(</span><span class=nx>path</span><span class=p>),</span><span class=w>  </span>
<span class=w>            </span><span class=nx>flagsNumber</span><span class=p>,</span><span class=w>  </span>
<span class=w>            </span><span class=mo>0o666</span><span class=p>,</span><span class=w>  </span>
<span class=w>            </span><span class=nx>req</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>ReadFileContext对象用于管理文件读操作整个过程，FSReqCallback是对uv_fs_t的封装，每次读操作对于Libuv来说就是一次请求，该请求的上下文就是使用uv_fs_t表示。请求完成后，会执行FSReqCallback对象的oncomplete函数。所以我们继续看readFileAfterOpen。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>readFileAfterOpen</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>fd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>context</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 打开出错则直接执行用户回调，传入err  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>context</span><span class=p>.</span><span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 保存打开文件的fd  </span>
<span class=w>      </span><span class=nx>context</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fd</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 新建一个FSReqCallback对象管理下一个异步请求和回调  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>FSReqCallback</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=nx>req</span><span class=p>.</span><span class=nx>oncomplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>readFileAfterStat</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=nx>req</span><span class=p>.</span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>context</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 获取文件的元数据，拿到文件大小  </span>
<span class=w>      </span><span class=nx>binding</span><span class=p>.</span><span class=nx>fstat</span><span class=p>(</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>拿到文件的元数据后，执行readFileAfterStat，这段逻辑和同步的类似，根据元数据中记录的文件大小，分配一个buffer用于后续读取文件内容。然后执行读操作。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=nx>read</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=nx>buffer</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=nx>offset</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=nx>length</span><span class=p>;</span><span class=w>  </span>

<span class=w>        </span><span class=c1>// 省略部分buffer处理的逻辑  </span>
<span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>FSReqCallback</span><span class=p>();</span><span class=w>  </span>
<span class=w>        </span><span class=nx>req</span><span class=p>.</span><span class=nx>oncomplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>readFileAfterRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=nx>req</span><span class=p>.</span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>  </span>

<span class=w>        </span><span class=nx>read</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=p>,</span><span class=w> </span><span class=nx>offset</span><span class=p>,</span><span class=w> </span><span class=nx>length</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mf>1</span><span class=p>,</span><span class=w> </span><span class=nx>req</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>再次新建一个FSReqCallback对象管理异步读取操作和回调。我们看一下C++层read函数的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code>    // 拿到C++层的FSReqCallback对象  
    FSReqBase* req_wrap_async = GetReqWrap(env, args[5]);  
    // 异步调用uv_fs_read  
    AsyncCall(env, req_wrap_async, args, &quot;read&quot;, UTF8, AfterInteger,uv_fs_read, fd, &amp;uvbuf, 1, pos);  
</code></pre></div></td></tr></table></div> <p>AsyncCall最后调用Libuv的uv_fs_read函数。我们看一下这个函数的关键逻辑。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>                        </span><span class=err>\</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cb</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>          </span><span class=err>\</span><span class=w>  </span>
<span class=w>          </span><span class=n>uv__req_register</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=n>req</span><span class=p>);</span><span class=w>  </span><span class=err>\</span><span class=w>  </span>
<span class=w>          </span><span class=n>uv__work_submit</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w>    </span><span class=err>\</span><span class=w>  </span>
<span class=w>                    </span><span class=o>&amp;</span><span class=n>req</span><span class=o>-&gt;</span><span class=n>work_req</span><span class=p>,</span><span class=w> </span><span class=err>\</span><span class=w>  </span>
<span class=w>                    </span><span class=n>UV__WORK_FAST_IO</span><span class=p>,</span><span class=w> </span><span class=err>\</span><span class=w>  </span>
<span class=w>                    </span><span class=n>uv__fs_work</span><span class=p>,</span><span class=w> </span><span class=err>\</span><span class=w>  </span>
<span class=w>                    </span><span class=n>uv__fs_done</span><span class=p>);</span><span class=w> </span><span class=err>\</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>               </span><span class=err>\</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>                          </span><span class=err>\</span><span class=w>  </span>
<span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>                    </span><span class=err>\</span><span class=w>  </span>
<span class=w>          </span><span class=n>uv__fs_work</span><span class=p>(</span><span class=o>&amp;</span><span class=n>req</span><span class=o>-&gt;</span><span class=n>work_req</span><span class=p>);</span><span class=w> </span><span class=err>\</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=n>req</span><span class=o>-&gt;</span><span class=n>result</span><span class=p>;</span><span class=w>     </span><span class=err>\</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>                           </span><span class=err>\</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>                            </span><span class=err>\</span><span class=w>  </span>
<span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>uv__work_submit是给线程池提交一个任务，当子线程执行这个任务时，就会执行uv__fs_work，uv__fs_work会调用操作系统的系统调用read，可能会导致阻塞。等到读取成功后执行uv__fs_done。uv__fs_done会执行C++层的回调，从而执行JS层的回调。JS层的回调是readFileAfterRead，这里就不具体展开，readFileAfterRead的逻辑是判断是否读取完毕，是的话执行用户回调，否则继续发起读取操作。</p> <h2 id=123>12.3 文件监听<a class=headerlink href=#123 title="Permanent link">&para;</a></h2> <p>文件监听是非常常用的功能，比如我们修改了文件后webpack重新打包代码或者Node.js服务重启，都用到了文件监听的功能，Node.js提供了两套文件监听的机制。</p> <h3 id=1231>12.3.1 基于轮询的文件监听机制<a class=headerlink href=#1231 title="Permanent link">&para;</a></h3> <p>基于轮询机制的文件监听API是watchFile。流程如图12-3所示。<br> <img alt src="https://img-blog.csdnimg.cn/94d2f921ebb44750be527e4b9abf5623.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"><br> 图12-3</p> <p>我们看一下具体实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>watchFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=nx>listener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>filename</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getValidatedPath</span><span class=p>(</span><span class=nx>filename</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=nx>filename</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>pathModule</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>filename</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>stat</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 省略部分参数处理逻辑  </span>
<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>interval</span><span class=o>:</span><span class=w> </span><span class=mf>5007</span><span class=p>,</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 一直轮询  </span>
<span class=w>        </span><span class=nx>persistent</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>  </span>
<span class=w>        </span><span class=p>...</span><span class=nx>options</span><span class=w>  </span>
<span class=w>      </span><span class=p>};</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// 缓存处理，filename是否已经开启过监听  </span>
<span class=w>      </span><span class=nx>stat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>statWatchers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>filename</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>stat</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>watchers</span><span class=p>)</span><span class=w>  </span>
<span class=w>          </span><span class=nx>watchers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;internal/fs/watchers&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=nx>stat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>watchers</span><span class=p>.</span><span class=nx>StatWatcher</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>bigint</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 开启监听  </span>
<span class=w>        </span><span class=nx>stat</span><span class=p>[</span><span class=nx>watchers</span><span class=p>.</span><span class=nx>kFSStatWatcherStart</span><span class=p>](</span><span class=nx>filename</span><span class=p>,</span><span class=w>        </span>
<span class=w>                                               </span><span class=nx>options</span><span class=p>.</span><span class=nx>persistent</span><span class=p>,</span><span class=w> </span>
<span class=w>                                               </span><span class=nx>options</span><span class=p>.</span><span class=nx>interval</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 更新缓存            </span>
<span class=w>        </span><span class=nx>statWatchers</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span><span class=w> </span><span class=nx>stat</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=nx>stat</span><span class=p>.</span><span class=nx>addListener</span><span class=p>(</span><span class=s1>&#39;change&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>listener</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>stat</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>StatWatcher是管理文件监听的类，我们看一下watchers.kFSStatWatcherStart方法的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=n>StatWatcher</span><span class=p>.</span><span class=n>prototype</span><span class=p>[</span><span class=n>kFSStatWatcherStart</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=n>persistent</span><span class=p>,</span><span class=w> </span><span class=n>interval</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=n>_handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>_StatWatcher</span><span class=p>(</span><span class=k>this</span><span class=p>[</span><span class=n>kUseBigint</span><span class=p>]);</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=n>_handle</span><span class=p>.</span><span class=n>onchange</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>onchange</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>filename</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getValidatedPath</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=err>&#39;</span><span class=n>filename</span><span class=err>&#39;</span><span class=p>);</span><span class=w> </span>
<span class=w>      </span><span class=k>const</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=n>_handle</span><span class=p>.</span><span class=n>start</span><span class=p>(</span><span class=n>toNamespacedPath</span><span class=p>(</span><span class=n>filename</span><span class=p>),</span><span class=w> </span>
<span class=w>                                          </span><span class=n>interval</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>新建一个_StatWatcher对象，_StatWatcher是C++模块提供的功能（node_stat_watcher.cc），然后执行它的start方法。Start方法执行Libuv的uv_fs_poll_start开始监听文件。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>uv_fs_poll_start</span><span class=p>(</span><span class=n>uv_fs_poll_t</span><span class=o>*</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=n>uv_fs_poll_cb</span><span class=w> </span><span class=n>cb</span><span class=p>,</span><span class=w>  </span>
<span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>interval</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 管理文件监听的数据结构  </span>
<span class=w>      </span><span class=k>struct</span><span class=w> </span><span class=nc>poll_ctx</span><span class=o>*</span><span class=w> </span><span class=n>ctx</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>uv_loop_t</span><span class=o>*</span><span class=w> </span><span class=n>loop</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>size_t</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>

<span class=w>      </span><span class=n>loop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>loop</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>path</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// calloc会把内存初始化为0</span>
<span class=w>      </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv__calloc</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>len</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>loop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loop</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// C++层回调</span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>poll_cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 多久轮询一次  </span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>interval</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>interval</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>start_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv_now</span><span class=p>(</span><span class=n>loop</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 关联的handle  </span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>parent_handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handle</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 监听的文件路径  </span>
<span class=w>      </span><span class=n>memcpy</span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 初始化定时器结构体  </span>
<span class=w>      </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv_timer_init</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>timer_handle</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 异步查询文件元数据  </span>
<span class=w>      </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv_fs_stat</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fs_req</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>poll_cb</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>poll_ctx</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>previous</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>poll_ctx</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 关联负责管理轮询的对象  </span>
<span class=w>      </span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>poll_ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>uv__handle_start</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>Start函数初始化一个poll_ctx结构体，用于管理文件监听，然后发起异步请求文件元数据的请求，获取元数据后，执行poll_cb回调。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>poll_cb</span><span class=p>(</span><span class=n>uv_fs_t</span><span class=o>*</span><span class=w> </span><span class=n>req</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=n>uv_stat_t</span><span class=o>*</span><span class=w> </span><span class=n>statbuf</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>struct</span><span class=w> </span><span class=nc>poll_ctx</span><span class=o>*</span><span class=w> </span><span class=n>ctx</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>uint64_t</span><span class=w> </span><span class=n>interval</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 通过结构体字段获取结构体首地址  </span>
<span class=w>      </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>container_of</span><span class=p>(</span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>poll_ctx</span><span class=p>,</span><span class=w> </span><span class=n>fs_req</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=n>statbuf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>req</span><span class=o>-&gt;</span><span class=n>statbuf</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/* </span>
<span class=cm>       第一次不执行回调，因为没有可对比的元数据，第二次及后续的操作才可能</span>
<span class=cm>          执行回调，busy_polling初始化的时候为0，第一次执行的时候置</span>
<span class=cm>          busy_polling=1 </span>
<span class=cm>      */</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>busy_polling</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 出错或者stat发生了变化则执行回调  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>busy_polling</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span>
<span class=w>                 </span><span class=o>!</span><span class=n>statbuf_eq</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>statbuf</span><span class=p>,</span><span class=w> </span><span class=n>statbuf</span><span class=p>))</span><span class=w>  </span>
<span class=w>          </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>poll_cb</span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>parent_handle</span><span class=p>,</span><span class=w> </span>
<span class=w>                             </span><span class=mi>0</span><span class=p>,</span>
<span class=w>                            </span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>statbuf</span><span class=p>,</span><span class=w> </span>
<span class=w>                             </span><span class=n>statbuf</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 保存当前获取到的stat信息，置1  </span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>statbuf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>statbuf</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>busy_polling</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>  </span>

<span class=w>    </span><span class=nl>out</span><span class=p>:</span><span class=w>  </span>
<span class=w>      </span><span class=n>uv_fs_req_cleanup</span><span class=p>(</span><span class=n>req</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>parent_handle</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<span class=w>        </span><span class=n>uv_close</span><span class=p>((</span><span class=n>uv_handle_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>timer_handle</span><span class=p>,</span><span class=w> </span><span class=n>timer_close_cb</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/* </span>
<span class=cm>        假设在开始时间点为1，interval为10的情况下执行了stat，stat</span>
<span class=cm>            完成执行并执行poll_cb回调的时间点是3，那么定时器的超时时间</span>
<span class=cm>            则为10-3=7，即7个单位后就要触发超时，而不是10，是因为stat</span>
<span class=cm>            阻塞消耗了3个单位的时间，所以下次执行超时回调函数时说明从</span>
<span class=cm>            start时间点开始算，已经经历了x单位各interval，然后超时回调里</span>
<span class=cm>            又执行了stat函数，再到执行stat回调，这个时间点即now=start+x</span>
<span class=cm>            单位个interval+stat消耗的时间。得出now-start为interval的</span>
<span class=cm>            x倍+stat消耗，即对interval取余可得到stat消耗，所以当前轮，</span>
<span class=cm>            定时器的超时时间为interval - ((now-start) % interval) </span>
<span class=cm>      */</span><span class=w>  </span>
<span class=w>      </span><span class=n>interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>interval</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uv_now</span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>loop</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>start_time</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>interval</span><span class=p>;</span><span class=w> </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>uv_timer_start</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>timer_handle</span><span class=p>,</span><span class=w> </span><span class=n>timer_cb</span><span class=p>,</span><span class=w> </span><span class=n>interval</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span>
<span class=w>        </span><span class=n>abort</span><span class=p>();</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>基于轮询的监听文件机制本质上是不断轮询文件的元数据，然后和上一次的元数据进行对比，如果有不一致的就认为文件变化了，因为第一次获取元数据时，还没有可以对比的数据，所以不认为是文件变化，这时候开启一个定时器。隔一段时间再去获取文件的元数据，如此反复，直到用户调stop函数停止这个行为。下面是Libuv关于文件变化的定义。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>statbuf_eq</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>uv_stat_t</span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>uv_stat_t</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_ctim</span><span class=p>.</span><span class=n>tv_nsec</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_ctim</span><span class=p>.</span><span class=n>tv_nsec</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_mtim</span><span class=p>.</span><span class=n>tv_nsec</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_mtim</span><span class=p>.</span><span class=n>tv_nsec</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_birthtim</span><span class=p>.</span><span class=n>tv_nsec</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_birthtim</span><span class=p>.</span><span class=n>tv_nsec</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_ctim</span><span class=p>.</span><span class=n>tv_sec</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_ctim</span><span class=p>.</span><span class=n>tv_sec</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_mtim</span><span class=p>.</span><span class=n>tv_sec</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_mtim</span><span class=p>.</span><span class=n>tv_sec</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_birthtim</span><span class=p>.</span><span class=n>tv_sec</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_birthtim</span><span class=p>.</span><span class=n>tv_sec</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_size</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_size</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_mode</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_uid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_uid</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_gid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_gid</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_ino</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_ino</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_dev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_dev</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_flags</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_flags</span><span class=w>  </span>
<span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>a</span><span class=o>-&gt;</span><span class=n>st_gen</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>st_gen</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <h3 id=1232inotify>12.3.2基于inotify的文件监听机制<a class=headerlink href=#1232inotify title="Permanent link">&para;</a></h3> <p>我们看到基于轮询的监听其实效率是很低的，因为需要我们不断去轮询文件的元数据，如果文件大部分时间里都没有变化，那就会白白浪费CPU。如果文件改变了会主动通知我们那就好了，这就是基于inotify机制的文件监听。Node.js提供的接口是watch。watch的实现和watchFile的比较类似。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>watch</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=nx>listener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// Don&#39;t make changes directly on options object  </span>
<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>copyObject</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 是否持续监听</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>persistent</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span>
<span class=w>          </span><span class=nx>options</span><span class=p>.</span><span class=nx>persistent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 如果是目录，是否监听所有子目录和文件的变化</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>recursive</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span>
<span class=w>          </span><span class=nx>options</span><span class=p>.</span><span class=nx>recursive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 有些平台不支持</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>recursive</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=nx>isOSX</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>isWindows</span><span class=p>))</span><span class=w>  </span>
<span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>ERR_FEATURE_UNAVAILABLE_ON_PLATFORM</span><span class=p>(</span><span class=s1>&#39;watch recursively&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>watchers</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=nx>watchers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;internal/fs/watchers&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 新建一个FSWatcher对象管理文件监听，然后开启监听</span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>watcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>watchers</span><span class=p>.</span><span class=nx>FSWatcher</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=nx>watcher</span><span class=p>[</span><span class=nx>watchers</span><span class=p>.</span><span class=nx>kFSWatchStart</span><span class=p>](</span><span class=nx>filename</span><span class=p>,</span><span class=w>  </span>
<span class=w>                      </span><span class=nx>options</span><span class=p>.</span><span class=nx>persistent</span><span class=p>,</span><span class=w>  </span>
<span class=w>                      </span><span class=nx>options</span><span class=p>.</span><span class=nx>recursive</span><span class=p>,</span><span class=w>  </span>
<span class=w>                      </span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>listener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>watcher</span><span class=p>.</span><span class=nx>addListener</span><span class=p>(</span><span class=s1>&#39;change&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>listener</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>watcher</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>FSWatcher函数是对C++层FSEvent模块的封装。我们来看一下start函数的逻辑，start函数透过C++层调用了Libuv的uv_fs_event_start函数。在讲解uv_fs_event_start函数前，我们先了解一下inotify的原理和它在Libuv中的实现。inotify是Linux系统提供用于监听文件系统的机制。inotify机制的逻辑大致是<br> 1 init_inotify创建一个inotify的实例，返回一个文件描述符。类似epoll。<br> 2 inotify_add_watch往inotify实例注册一个需监听的文件（inotify_rm_watch是移除）。<br> 3 read(inotify实例对应的文件描述符, &amp;buf, sizeof(buf))，如果没有事件触发，则阻塞（除非设置了非阻塞）。否则返回待读取的数据长度。buf就是保存了触发事件的信息。<br> Libuv在inotify机制的基础上做了一层封装。我们看一下inotify在Libuv的架构图如图12-4所示。<br> <img alt src="https://img-blog.csdnimg.cn/2b745c9ea2884e0484c54e6facc39419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"><br> 图12-4</p> <p>我们再来看一下Libuv中的实现。我们从一个使用例子开始。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 实现循环核心结构体loop  </span>
<span class=w>        </span><span class=n>loop</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv_default_loop</span><span class=p>();</span><span class=w>   </span>
<span class=w>        </span><span class=n>uv_fs_event_t</span><span class=w> </span><span class=o>*</span><span class=n>fs_event_req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>uv_fs_event_t</span><span class=p>));</span>
<span class=w>        </span><span class=c1>// 初始化fs_event_req结构体的类型为UV_FS_EVENT  </span>
<span class=w>        </span><span class=n>uv_fs_event_init</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=n>fs_event_req</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=cm>/* </span>
<span class=cm>              argv[argc]是文件路径，</span>
<span class=cm>              uv_fs_event_start 向底层注册监听文件argv[argc],</span>
<span class=cm>              cb是事件触发时的回调 </span>
<span class=cm>            */</span><span class=w>  </span>
<span class=w>        </span><span class=n>uv_fs_event_start</span><span class=p>(</span><span class=n>fs_event_req</span><span class=p>,</span><span class=w> </span>
<span class=w>                              </span><span class=n>cb</span><span class=p>,</span><span class=w> </span>
<span class=w>                              </span><span class=n>argv</span><span class=p>[</span><span class=n>argc</span><span class=p>],</span><span class=w> </span>
<span class=w>                              </span><span class=n>UV_FS_EVENT_RECURSIVE</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 开启事件循环  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>uv_run</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=n>UV_RUN_DEFAULT</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>Libuv在第一次监听文件的时候(调用uv_fs_event_start的时候)，会创建一个inotify实例。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>init_inotify</span><span class=p>(</span><span class=n>uv_loop_t</span><span class=o>*</span><span class=w> </span><span class=n>loop</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 初始化过了则直接返回       </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_fd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/*</span>
<span class=cm>          调用操作系统的inotify_init函数申请一个inotify实例，</span>
<span class=cm>          并设置UV__IN_NONBLOCK，UV__IN_CLOEXEC标记  </span>
<span class=cm>        */</span>
<span class=w>      </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new_inotify_fd</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 记录inotify实例对应的文件描述符,一个事件循环一个inotify实例  </span>
<span class=w>      </span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/*</span>
<span class=cm>          inotify_read_watcher是一个IO观察者，</span>
<span class=cm>          uv__io_init设置IO观察者的文件描述符（待观察的文件）和回调  </span>
<span class=cm>        */</span>
<span class=w>      </span><span class=n>uv__io_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_read_watcher</span><span class=p>,</span><span class=w> </span>
<span class=w>                    </span><span class=n>uv__inotify_read</span><span class=p>,</span><span class=w> </span>
<span class=w>                    </span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_fd</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 往Libuv中注册该IO观察者，感兴趣的事件为可读  </span>
<span class=w>      </span><span class=n>uv__io_start</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_read_watcher</span><span class=p>,</span><span class=w> </span><span class=n>POLLIN</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>Libuv把inotify实例对应的fd通过uv__io_start注册到epoll中，当有文件变化的时候，就会执行回调uv__inotify_read。分析完Libuv申请inotify实例的逻辑，我们回到main函数看看uv_fs_event_start函数。用户使用uv_fs_event_start函数来往Libuv注册一个待监听的文件。我们看看实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>uv_fs_event_start</span><span class=p>(</span><span class=n>uv_fs_event_t</span><span class=o>*</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=w>  </span>
<span class=w>                          </span><span class=n>uv_fs_event_cb</span><span class=w> </span><span class=n>cb</span><span class=p>,</span><span class=w>  </span>
<span class=w>                          </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w>  </span>
<span class=w>                          </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>struct</span><span class=w> </span><span class=nc>watcher_list</span><span class=o>*</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>events</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>wd</span><span class=p>;</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>uv__is_active</span><span class=p>(</span><span class=n>handle</span><span class=p>))</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UV_EINVAL</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 申请一个inotify实例  </span>
<span class=w>      </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>init_inotify</span><span class=p>(</span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>loop</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 监听的事件  </span>
<span class=w>      </span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UV__IN_ATTRIB</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_CREATE</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_MODIFY</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_DELETE</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_DELETE_SELF</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_MOVE_SELF</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_MOVED_FROM</span><span class=w>  </span>
<span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>UV__IN_MOVED_TO</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 调用操作系统的函数注册一个待监听的文件，返回一个对应于该文件的id  </span>
<span class=w>      </span><span class=n>wd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv__inotify_add_watch</span><span class=p>(</span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_fd</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>events</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>wd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UV__ERR</span><span class=p>(</span><span class=n>errno</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 判断该文件是不是已经注册过了  </span>
<span class=w>      </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>find_watcher</span><span class=p>(</span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=n>wd</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 已经注册过则跳过插入的逻辑  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>w</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>no_insert</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 还没有注册过则插入Libuv维护的红黑树  </span>
<span class=w>      </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uv__malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>w</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>w</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UV_ENOMEM</span><span class=p>;</span><span class=w>  </span>

<span class=w>      </span><span class=n>w</span><span class=o>-&gt;</span><span class=n>wd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>wd</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>w</span><span class=o>-&gt;</span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strcpy</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)(</span><span class=n>w</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>),</span><span class=w> </span><span class=n>path</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=n>QUEUE_INIT</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>watchers</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=n>w</span><span class=o>-&gt;</span><span class=n>iterating</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 插入Libuv维护的红黑树,inotify_watchers是根节点  </span>
<span class=w>      </span><span class=n>RB_INSERT</span><span class=p>(</span><span class=n>watcher_root</span><span class=p>,</span><span class=w> </span><span class=n>CAST</span><span class=p>(</span><span class=o>&amp;</span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_watchers</span><span class=p>),</span><span class=w> </span><span class=n>w</span><span class=p>);</span><span class=w>  </span>

<span class=w>    </span><span class=nl>no_insert</span><span class=p>:</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 激活该handle  </span>
<span class=w>      </span><span class=n>uv__handle_start</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 同一个文件可能注册了很多个回调，w对应一个文件，注册在用一个文件的回调排成队  </span>
<span class=w>      </span><span class=n>QUEUE_INSERT_TAIL</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>watchers</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>watchers</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 保存信息和回调  </span>
<span class=w>      </span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>w</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>handle</span><span class=o>-&gt;</span><span class=n>wd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>wd</span><span class=p>;</span><span class=w>  </span>

<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>下面我们逐步分析上面的函数逻辑。<br> 1 如果是首次调用该函数则新建一个inotify实例。并且往Libuv插入一个观察者io，Libuv会在Poll IO阶段注册到epoll中。<br> 2 往操作系统注册一个待监听的文件。返回一个id。<br> 3 Libuv判断该id是不是在自己维护的红黑树中。不在红黑树中，则插入红黑树。返回一个红黑树中对应的节点。把本次请求的信息封装到handle中（回调时需要）。然后把handle插入刚才返回的节点的队列中。<br> 这时候注册过程就完成了。Libuv在Poll IO阶段如果检测到有文件发生变化，则会执行回调uv__inotify_read。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>uv__inotify_read</span><span class=p>(</span><span class=n>uv_loop_t</span><span class=o>*</span><span class=w> </span><span class=n>loop</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                 </span><span class=n>uv__io_t</span><span class=o>*</span><span class=w> </span><span class=n>dummy</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                 </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>events</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>uv__inotify_event</span><span class=o>*</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>struct</span><span class=w> </span><span class=nc>watcher_list</span><span class=o>*</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>uv_fs_event_t</span><span class=o>*</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>QUEUE</span><span class=w> </span><span class=n>queue</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>QUEUE</span><span class=o>*</span><span class=w> </span><span class=n>q</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>path</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kt>ssize_t</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/* needs to be large enough for sizeof(inotify_event) + strlen(path) */</span><span class=w>  </span>
<span class=w>      </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>4096</span><span class=p>];</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 一次可能没有读完  </span>
<span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>do</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 读取触发的事件信息，size是数据大小，buffer保存数据  </span>
<span class=w>          </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>loop</span><span class=o>-&gt;</span><span class=n>inotify_fd</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span><span class=w>  </span>
<span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EINTR</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 没有数据可取了  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=n>assert</span><span class=p>(</span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EAGAIN</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>errno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EWOULDBLOCK</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=k>break</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 处理buffer的信息  </span>
<span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>len</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// buffer里是多个uv__inotify_event结构体，里面保存了事件信息和文件对应的id（wd字段）  </span>
<span class=w>          </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>uv__inotify_event</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=p>;</span><span class=w>  </span>

<span class=w>          </span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>mask</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>UV__IN_ATTRIB</span><span class=o>|</span><span class=n>UV__IN_MODIFY</span><span class=p>))</span><span class=w>  </span>
<span class=w>            </span><span class=n>events</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>UV_CHANGE</span><span class=p>;</span><span class=w>  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>mask</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=p>(</span><span class=n>UV__IN_ATTRIB</span><span class=o>|</span><span class=n>UV__IN_MODIFY</span><span class=p>))</span><span class=w>  </span>
<span class=w>            </span><span class=n>events</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>UV_RENAME</span><span class=p>;</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 通过文件对应的id（wd字段）从红黑树中找到对应的节点  </span>
<span class=w>          </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>find_watcher</span><span class=p>(</span><span class=n>loop</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>wd</span><span class=p>);</span><span class=w>  </span>

<span class=w>          </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>len</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>uv__basename_r</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=n>w</span><span class=o>-&gt;</span><span class=n>iterating</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 把红黑树中，wd对应节点的handle队列移到queue变量，准备处理  </span>
<span class=w>          </span><span class=n>QUEUE_MOVE</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>watchers</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>queue</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>QUEUE_EMPTY</span><span class=p>(</span><span class=o>&amp;</span><span class=n>queue</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>              </span><span class=c1>// 头结点  </span>
<span class=w>            </span><span class=n>q</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>QUEUE_HEAD</span><span class=p>(</span><span class=o>&amp;</span><span class=n>queue</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=c1>// 通过结构体偏移拿到首地址  </span>
<span class=w>            </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>QUEUE_DATA</span><span class=p>(</span><span class=n>q</span><span class=p>,</span><span class=w> </span><span class=n>uv_fs_event_t</span><span class=p>,</span><span class=w> </span><span class=n>watchers</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=c1>// 从处理队列中移除  </span>
<span class=w>            </span><span class=n>QUEUE_REMOVE</span><span class=p>(</span><span class=n>q</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=c1>// 放回原队列  </span>
<span class=w>            </span><span class=n>QUEUE_INSERT_TAIL</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>watchers</span><span class=p>,</span><span class=w> </span><span class=n>q</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=c1>// 执行回调  </span>
<span class=w>            </span><span class=n>h</span><span class=o>-&gt;</span><span class=n>cb</span><span class=p>(</span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>events</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>uv__inotify_read函数的逻辑就是从操作系统中把数据读取出来，这些数据中保存了哪些文件触发了用户感兴趣的事件。然后遍历每个触发了事件的文件。从红黑树中找到该文件对应的红黑树节点。再取出红黑树节点中维护的一个handle队列，最后执行handle队列中每个节点的回调。</p> <h2 id=124-promiseapi>12.4 Promise化API<a class=headerlink href=#124-promiseapi title="Permanent link">&para;</a></h2> <p>Node.js的API都是遵循callback模式的，比如我们要读取一个文件的内容。我们通常会这样写</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;filename&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf-8&#39;</span><span class=w> </span><span class=p>,(</span><span class=nx>err</span><span class=p>,</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w>  </span>
<span class=w>    </span><span class=p>})</span><span class=w>  </span>
<span class=w>    </span><span class=c1>//为了支持Promise模式，我们通常这样写</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>readFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span><span class=w> </span><span class=nx>reject</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf-8&#39;</span><span class=w> </span><span class=p>,(</span><span class=nx>err</span><span class=p>,</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>                </span><span class=nx>err</span><span class=w> </span><span class=o>?</span><span class=w>  </span><span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>resolve</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=p>});</span><span class=w>  </span>
<span class=w>        </span><span class=p>});</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>但是在Node.js V14中，文件模块支持了Promise化的api。我们可以直接使用await进行文件操作。我们看一下使用例子。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>open</span><span class=p>,</span><span class=w> </span><span class=nx>readFile</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>).</span><span class=nx>promises</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>runDemo</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>   </span>
<span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;11111.md&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>encoding</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;utf-8&#39;</span><span class=w> </span><span class=p>}));</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=p>){</span><span class=w>  </span>

<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=nx>runDemo</span><span class=p>();</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>从例子中我们看到，和之前的API调用方式类似，不同的地方在于我们不用再写回调了，而是通过await的方式接收结果。这只是新版API的特性之一。在新版API之前，文件模块大部分API都是类似工具函数，比如readFile，writeFile，新版API中支持面向对象的调用方式。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>open</span><span class=p>,</span><span class=w> </span><span class=nx>readFile</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>).</span><span class=nx>promises</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>runDemo</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>filehandle</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>filehandle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>open</span><span class=p>(</span><span class=s1>&#39;filename&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// console.log(await readFile(filehandle, { encoding: &#39;utf-8&#39; }));  </span>
<span class=w>        </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=nx>filehandle</span><span class=p>.</span><span class=nx>readFile</span><span class=p>({</span><span class=w> </span><span class=nx>encoding</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;utf-8&#39;</span><span class=w> </span><span class=p>}));</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>filehandle</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=k>await</span><span class=w> </span><span class=nx>filehandle</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span><span class=w>     </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=nx>runDemo</span><span class=p>();</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>面向对象的模式中，我们首先需要通过open函数拿到一个FileHandle对象（对文件描述符的封装），然后就可以在该对象上调各种文件操作的函数。在使用面向对象模式的API时有一个需要注意的地方是Node.js不会为我们关闭文件描述符，即使文件操作出错，所以我们需要自己手动关闭文件描述符，否则会造成文件描述符泄漏，而在非面向对象模式中，在文件操作完毕后，不管成功还是失败，Node.js都会为我们关闭文件描述符。下面我们看一下具体的实现。首先介绍一个FileHandle类。该类是对文件描述符的封装，提供了面向对象的API。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>class</span><span class=w> </span><span class=nx>FileHandle</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=kr>constructor</span><span class=p>(</span><span class=nx>filehandle</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// filehandle为C++对象  </span>
<span class=w>        </span><span class=k>this</span><span class=p>[</span><span class=nx>kHandle</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>filehandle</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>[</span><span class=nx>kFd</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>filehandle</span><span class=p>.</span><span class=nx>fd</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=nx>get</span><span class=w> </span><span class=nx>fd</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>[</span><span class=nx>kFd</span><span class=p>];</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=nx>readFile</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>readFile</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=nx>close</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>[</span><span class=nx>kFd</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mf>1</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>[</span><span class=nx>kHandle</span><span class=p>].</span><span class=nx>close</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 省略部分操作文件的api  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>FileHandle的逻辑比较简单，首先封装了一系列文件操作的API，然后实现了close函数用于关闭底层的文件描述符。 1 操作文件系统API 这里我们以readFile为例进行分析</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>readFile</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getOptions</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>flag</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=w> </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>flag</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 以面向对象的方式使用，这时候需要自己关闭文件描述符  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>path</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>FileHandle</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>readFileHandle</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 直接调用，首先需要先打开文件描述符，读取完毕后Node.js会主动关闭文件描述符  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>open</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>flag</span><span class=p>,</span><span class=w> </span><span class=mo>0o666</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>readFileHandle</span><span class=p>(</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>).</span><span class=k>finally</span><span class=p>(</span><span class=nx>fd</span><span class=p>.</span><span class=nx>close</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>从readFile代码中我们看到不同调用方式下，Node.js的处理是不一样的，当FileHandle是我们维护时，关闭操作也是我们负责执行，当FileHandle是Node.js维护时，Node.js在文件操作完毕后，不管成功还是失败都会主动关闭文件描述符。接着我们看到readFileHandle的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>readFileHandle</span><span class=p>(</span><span class=nx>filehandle</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 获取文件元信息  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>statFields</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>binding</span><span class=p>.</span><span class=nx>fstat</span><span class=p>(</span><span class=nx>filehandle</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>kUsePromises</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>size</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 是不是普通文件，根据文件类型获取对应大小  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=nx>statFields</span><span class=p>[</span><span class=mf>1</span><span class=cm>/* mode */</span><span class=p>]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=nx>S_IFMT</span><span class=p>)</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>S_IFREG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>statFields</span><span class=p>[</span><span class=mf>8</span><span class=cm>/* size */</span><span class=p>];</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 太大了  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>size</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nx>kIoMaxLength</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>ERR_FS_FILE_TOO_LARGE</span><span class=p>(</span><span class=nx>size</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>chunks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[];</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 计算每次读取的大小  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>chunkSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>size</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=w> </span><span class=o>?</span><span class=w>  </span>
<span class=w>        </span><span class=nx>kReadFileMaxChunkSize</span><span class=w> </span><span class=o>:</span><span class=w>  </span>
<span class=w>        </span><span class=nx>MathMin</span><span class=p>(</span><span class=nx>size</span><span class=p>,</span><span class=w> </span><span class=nx>kReadFileMaxChunkSize</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>endOfFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 分配内存承载数据  </span>
<span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=nx>alloc</span><span class=p>(</span><span class=nx>chunkSize</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 读取的数据和大小  </span>
<span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w>  </span>
<span class=w>          </span><span class=k>await</span><span class=w> </span><span class=nx>read</span><span class=p>(</span><span class=nx>filehandle</span><span class=p>,</span><span class=w> </span><span class=nx>buf</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>chunkSize</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mf>1</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 是否读完了  </span>
<span class=w>        </span><span class=nx>endOfFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>bytesRead</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 读取了有效数据则把有效数据部分存起来  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w>  </span>
<span class=w>          </span><span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>buffer</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>));</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>endOfFile</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span><span class=nx>chunks</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>result</span><span class=p>.</span><span class=nx>toString</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>result</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>接着我们看read函数的实现</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>read</span><span class=p>(</span><span class=nx>handle</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=p>,</span><span class=w> </span><span class=nx>offset</span><span class=p>,</span><span class=w> </span><span class=nx>length</span><span class=p>,</span><span class=w> </span><span class=nx>position</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// ...  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=nx>binding</span><span class=p>.</span><span class=nx>read</span><span class=p>(</span><span class=nx>handle</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=p>,</span><span class=w> </span><span class=nx>offset</span><span class=p>,</span><span class=w> </span><span class=nx>length</span><span class=p>,</span><span class=w> </span><span class=nx>position</span><span class=p>,</span><span class=w> </span><span class=nx>kUsePromises</span><span class=p>))</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>,</span><span class=w> </span><span class=nx>buffer</span><span class=w> </span><span class=p>};</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>Read最终执行了node_file.cc 的Read。我们看一下Read函数的关键代码。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>Read</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>FunctionCallbackInfo</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Environment</span><span class=o>::</span><span class=n>GetCurrent</span><span class=p>(</span><span class=n>args</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// ...  </span>
<span class=w>      </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>req_wrap_async</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GetReqWrap</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>[</span><span class=mi>5</span><span class=p>]);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 异步执行，有两种情况  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>req_wrap_async</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=k>nullptr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=n>AsyncCall</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>req_wrap_async</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=s>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=n>UTF8</span><span class=p>,</span><span class=w> </span><span class=n>AfterInteger</span><span class=p>,</span><span class=w>  </span>
<span class=w>                  </span><span class=n>uv_fs_read</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>uvbuf</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 同步执行，比如fs.readFileSync  </span>
<span class=w>        </span><span class=n>CHECK_EQ</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=n>FSReqWrapSync</span><span class=w> </span><span class=n>req_wrap_sync</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=n>FS_SYNC_TRACE_BEGIN</span><span class=p>(</span><span class=n>read</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SyncCall</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>req_wrap_sync</span><span class=p>,</span><span class=w> </span><span class=s>&quot;read&quot;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                       </span><span class=n>uv_fs_read</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>uvbuf</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=n>FS_SYNC_TRACE_END</span><span class=p>(</span><span class=n>read</span><span class=p>,</span><span class=w> </span><span class=s>&quot;bytesRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>bytesRead</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=n>args</span><span class=p>.</span><span class=n>GetReturnValue</span><span class=p>().</span><span class=n>Set</span><span class=p>(</span><span class=n>bytesRead</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>Read函数分为三种情况，同步和异步，其中异步又分为两种，callback模式和Promise模式。我们看一下异步模式的实现。我们首先看一下这句代码。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code>    FSReqBase* req_wrap_async = GetReqWrap(env, args[5]);  
</code></pre></div></td></tr></table></div> <p>GetReqWrap根据第六个参数获取对应的值。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=nf>GetReqWrap</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w>  </span>
<span class=w>                          </span><span class=kt>bool</span><span class=w> </span><span class=n>use_bigint</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 是对象说明是继承FSReqBase的对象,比如FSReqCallback（异步模式）                      </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=o>-&gt;</span><span class=n>IsObject</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Unwrap</span><span class=o>&lt;</span><span class=n>FSReqBase</span><span class=o>&gt;</span><span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=n>As</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>());</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=o>-&gt;</span><span class=n>StrictEquals</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>fs_use_promises_symbol</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// Promise模式（异步模式）  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>use_bigint</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=n>FSReqPromise</span><span class=o>&lt;</span><span class=n>AliasedBigUint64Array</span><span class=o>&gt;::</span><span class=n>New</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>use_bigint</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=n>FSReqPromise</span><span class=o>&lt;</span><span class=n>AliasedFloat64Array</span><span class=o>&gt;::</span><span class=n>New</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>use_bigint</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 同步模式  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>这里我们只关注Promise模式。所以GetReqWrap返回的是一个FSReqPromise对象，我们回到Read函数。看到以下代码</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>req_wrap_async</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GetReqWrap</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>[</span><span class=mi>5</span><span class=p>]);</span><span class=w>  </span>
<span class=w>    </span><span class=n>AsyncCall</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>req_wrap_async</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=s>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=n>UTF8</span><span class=p>,</span><span class=w> </span><span class=n>AfterInteger</span><span class=p>,</span><span class=w>  </span>
<span class=w>                  </span><span class=n>uv_fs_read</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>uvbuf</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>pos</span><span class=p>);</span><span class=w>  </span>
<span class=n>继续看AsyncCall函数</span><span class=err>（</span><span class=n>node_file</span><span class=o>-</span><span class=n>inl</span><span class=p>.</span><span class=n>h</span><span class=err>）</span>
<span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>Func</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span><span class=w>  </span>
<span class=w>    </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>AsyncCall</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w>  </span>
<span class=w>                         </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>req_wrap</span><span class=p>,</span><span class=w>  </span>
<span class=w>                         </span><span class=k>const</span><span class=w> </span><span class=n>v8</span><span class=o>::</span><span class=n>FunctionCallbackInfo</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w>  </span>
<span class=w>                         </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>syscall</span><span class=p>,</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=nc>encoding</span><span class=w> </span><span class=n>enc</span><span class=p>,</span><span class=w>  </span>
<span class=w>                         </span><span class=n>uv_fs_cb</span><span class=w> </span><span class=n>after</span><span class=p>,</span><span class=w> </span><span class=n>Func</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w> </span><span class=n>Args</span><span class=p>...</span><span class=w> </span><span class=n>fn_args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>AsyncDestCall</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>req_wrap</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w>  </span>
<span class=w>                           </span><span class=n>syscall</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>enc</span><span class=p>,</span><span class=w>  </span>
<span class=w>                           </span><span class=n>after</span><span class=p>,</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w> </span><span class=n>fn_args</span><span class=p>...);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>AsyncCall是对AsyncDestCall的封装</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>Func</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span><span class=w>  </span>
<span class=w>    </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>AsyncDestCall</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>req_wrap</span><span class=p>,</span><span class=w>  </span>
<span class=w>                             </span><span class=k>const</span><span class=w> </span><span class=n>v8</span><span class=o>::</span><span class=n>FunctionCallbackInfo</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w>  </span>
<span class=w>                             </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>syscall</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>dest</span><span class=p>,</span><span class=w>  </span>
<span class=w>                             </span><span class=kt>size_t</span><span class=w> </span><span class=n>len</span><span class=p>,</span><span class=w> </span><span class=k>enum</span><span class=w> </span><span class=nc>encoding</span><span class=w> </span><span class=n>enc</span><span class=p>,</span><span class=w> </span><span class=n>uv_fs_cb</span><span class=w> </span><span class=n>after</span><span class=p>,</span><span class=w>  </span>
<span class=w>                             </span><span class=n>Func</span><span class=w> </span><span class=n>fn</span><span class=p>,</span><span class=w> </span><span class=n>Args</span><span class=p>...</span><span class=w> </span><span class=n>fn_args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=n>CHECK_NOT_NULL</span><span class=p>(</span><span class=n>req_wrap</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>Init</span><span class=p>(</span><span class=n>syscall</span><span class=p>,</span><span class=w> </span><span class=n>dest</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>,</span><span class=w> </span><span class=n>enc</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 调用libuv函数  </span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>Dispatch</span><span class=p>(</span><span class=n>fn</span><span class=p>,</span><span class=w> </span><span class=n>fn_args</span><span class=p>...,</span><span class=w> </span><span class=n>after</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 失败则直接执行回调，否则返回一个Promise，见SetReturnValue函数  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=n>uv_fs_t</span><span class=o>*</span><span class=w> </span><span class=n>uv_req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>req</span><span class=p>();</span><span class=w>  </span>
<span class=w>        </span><span class=n>uv_req</span><span class=o>-&gt;</span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=n>uv_req</span><span class=o>-&gt;</span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=n>after</span><span class=p>(</span><span class=n>uv_req</span><span class=p>);</span><span class=w>  </span><span class=c1>// after may delete req_wrap if there is an error  </span>
<span class=w>        </span><span class=n>req_wrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>SetReturnValue</span><span class=p>(</span><span class=n>args</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>req_wrap</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>AsyncDestCall函数主要做了两个操作，首先通过Dispatch调用底层Libuv的函数，比如这里是uv_fs_read。如果出错执行回调返回错误，否则执行req_wrap-&gt;SetReturnValue(args)。我们知道req_wrap是在GetReqWrap函数中由FSReqPromise<aliasedbiguint64array>::New(env, use_bigint)创建。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>AliasedBufferT</span><span class=o>&gt;</span><span class=w>  </span>
<span class=w>    </span><span class=n>FSReqPromise</span><span class=o>&lt;</span><span class=n>AliasedBufferT</span><span class=o>&gt;*</span><span class=w>  </span>
<span class=w>    </span><span class=n>FSReqPromise</span><span class=o>&lt;</span><span class=n>AliasedBufferT</span><span class=o>&gt;::</span><span class=n>New</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>use_bigint</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 创建一个C++对象存到obj中  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>fsreqpromise_constructor_template</span><span class=p>()</span><span class=w>  </span>
<span class=w>               </span><span class=o>-&gt;</span><span class=n>NewInstance</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>())</span><span class=w>  </span>
<span class=w>               </span><span class=p>.</span><span class=n>ToLocal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>obj</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 设置一个promise属性，值是一个Promise::Resolver  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Promise</span><span class=o>::</span><span class=n>Resolver</span><span class=o>&gt;</span><span class=w> </span><span class=n>resolver</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>v8</span><span class=o>::</span><span class=n>Promise</span><span class=o>::</span><span class=n>Resolver</span><span class=o>::</span><span class=n>New</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>()).</span><span class=n>ToLocal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>resolver</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w>  </span>
<span class=w>          </span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>Set</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>(),</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>promise_string</span><span class=p>(),</span><span class=w> </span><span class=n>resolver</span><span class=p>).</span><span class=n>IsNothing</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 返回另一个C++对象，里面保存了obj，obj也保存了指向FSReqPromise对象的指针  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FSReqPromise</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>use_bigint</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>所以req_wrap是一个FSReqPromise对象。我们看一下FSReqPromise对象的SetReturnValue方法。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>AliasedBufferT</span><span class=o>&gt;</span><span class=w>  </span>
<span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>FSReqPromise</span><span class=o>&lt;</span><span class=n>AliasedBufferT</span><span class=o>&gt;::</span><span class=n>SetReturnValue</span><span class=p>(</span><span class=w>  </span>
<span class=w>        </span><span class=k>const</span><span class=w> </span><span class=n>v8</span><span class=o>::</span><span class=n>FunctionCallbackInfo</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 拿到Promise::Resolver对象  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w>  </span>
<span class=w>          </span><span class=n>object</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Get</span><span class=p>(</span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>(),</span><span class=w>  </span>
<span class=w>                        </span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>promise_string</span><span class=p>()).</span><span class=n>ToLocalChecked</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Promise</span><span class=o>::</span><span class=n>Resolver</span><span class=o>&gt;</span><span class=w> </span><span class=n>resolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>val</span><span class=p>.</span><span class=n>As</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Promise</span><span class=o>::</span><span class=n>Resolver</span><span class=o>&gt;</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 拿到一个Promise作为返回值，即JS层拿到的值  </span>
<span class=w>      </span><span class=n>args</span><span class=p>.</span><span class=n>GetReturnValue</span><span class=p>().</span><span class=n>Set</span><span class=p>(</span><span class=n>resolver</span><span class=o>-&gt;</span><span class=n>GetPromise</span><span class=p>());</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>至此我们看到了新版API实现的核心逻辑，正是这个Promise返回值。通过层层返回后，在JS层就拿到这个Promise，然后处于pending状态等待决议。我们继续看一下Promise决议的逻辑。在分析Read函数中我们看到执行Libuv的uv_fs_read函数时，设置的回调是AfterInteger。那么当读取文件成功后就会执行该函数。所以我们看看该函数的逻辑。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>AfterInteger</span><span class=p>(</span><span class=n>uv_fs_t</span><span class=o>*</span><span class=w> </span><span class=n>req</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 通过属性拿到对象的地址  </span>
<span class=w>      </span><span class=n>FSReqBase</span><span class=o>*</span><span class=w> </span><span class=n>req_wrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FSReqBase</span><span class=o>::</span><span class=n>from_req</span><span class=p>(</span><span class=n>req</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=n>FSReqAfterScope</span><span class=w> </span><span class=n>after</span><span class=p>(</span><span class=n>req_wrap</span><span class=p>,</span><span class=w> </span><span class=n>req</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>after</span><span class=p>.</span><span class=n>Proceed</span><span class=p>())</span><span class=w>  </span>
<span class=w>        </span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>Resolve</span><span class=p>(</span><span class=n>Integer</span><span class=o>::</span><span class=n>New</span><span class=p>(</span><span class=n>req_wrap</span><span class=o>-&gt;</span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>isolate</span><span class=p>(),</span><span class=w> </span><span class=n>req</span><span class=o>-&gt;</span><span class=n>result</span><span class=p>));</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>   </span>
</code></pre></div></td></tr></table></div> <p>接着我们看一下Resolve</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>AliasedBufferT</span><span class=o>&gt;</span><span class=w>  </span>
<span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=n>FSReqPromise</span><span class=o>&lt;</span><span class=n>AliasedBufferT</span><span class=o>&gt;::</span><span class=n>Resolve</span><span class=p>(</span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=n>finished_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>HandleScope</span><span class=w> </span><span class=nf>scope</span><span class=p>(</span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>isolate</span><span class=p>());</span><span class=w>  </span>
<span class=w>      </span><span class=n>InternalCallbackScope</span><span class=w> </span><span class=nf>callback_scope</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 拿到保存的Promise对象，修改状态为resolve，并设置结果  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w>  </span>
<span class=w>          </span><span class=n>object</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>Get</span><span class=p>(</span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>(),</span><span class=w>  </span>
<span class=w>                        </span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>promise_string</span><span class=p>()).</span><span class=n>ToLocalChecked</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=n>v8</span><span class=o>::</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Promise</span><span class=o>::</span><span class=n>Resolver</span><span class=o>&gt;</span><span class=w> </span><span class=n>resolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>val</span><span class=p>.</span><span class=n>As</span><span class=o>&lt;</span><span class=n>v8</span><span class=o>::</span><span class=n>Promise</span><span class=o>::</span><span class=n>Resolver</span><span class=o>&gt;</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=n>USE</span><span class=p>(</span><span class=n>resolver</span><span class=o>-&gt;</span><span class=n>Resolve</span><span class=p>(</span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>(),</span><span class=w> </span><span class=n>value</span><span class=p>).</span><span class=n>FromJust</span><span class=p>());</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>Resolve函数修改Promise的状态和设置返回值，从而JS层拿到这个决议的值。回到fs层</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=nx>binding</span><span class=p>.</span><span class=nx>read</span><span class=p>(</span><span class=nx>handle</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span>
<span class=w>                                             </span><span class=nx>buffer</span><span class=p>,</span><span class=w> </span>
<span class=w>                                             </span><span class=nx>offset</span><span class=p>,</span><span class=w> </span>
<span class=w>                                             </span><span class=nx>length</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                          </span><span class=nx>position</span><span class=p>,</span><span class=w> </span><span class=nx>kUsePromises</span><span class=p>))</span><span class=o>|</span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>我们就拿到了返回值。</p> <h2 id=125-api>12.5 流式API<a class=headerlink href=#125-api title="Permanent link">&para;</a></h2> <p>前面分析了Node.js中文件模块的多种文件操作的方式，不管是同步、异步还是Promise化的API，它们都有一个问题就是对于用户来说，文件操作都是一次性完成的，比如我们调用readFile读取一个文件时，Node.js会通过一次或多次调用操作系统的接口把所有的文件内容读到内存中，同样我们调用writeFile写一个文件时，Node.js会通过一次或多次调用操作系统接口把用户的数据写入硬盘，这对内存来说是非常有压力的。假设我们有这样的一个场景，我们需要读取一个文件的内容，然后返回给前端，如果我们直接读取整个文件内容，然后再执行写操作这无疑是非常消耗内存，也是非常低效的。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>http</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;11111.md&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>})</span><span class=w>  </span>
<span class=w>    </span><span class=p>}).</span><span class=nx>listen</span><span class=p>(</span><span class=mf>11111</span><span class=p>);</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>这时候我们需要使用流式的API。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>http</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=s1>&#39;11111.md&#39;</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>}).</span><span class=nx>listen</span><span class=p>(</span><span class=mf>11111</span><span class=p>);</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>流式API的好处在于文件的内容并不是一次性读取到内存的，而是部分读取，消费完后再继续读取。Node.js内部帮我们做了流量的控制，如图12-5所示。<br> <img alt src="https://img-blog.csdnimg.cn/c062c8fc963e4416bf515e87d1c96260.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"><br> 图12-5<br> 下面我们看一下Node.js流式API的具体实现。</p> <h3 id=1251>12.5.1 可读文件流<a class=headerlink href=#1251 title="Permanent link">&para;</a></h3> <p>可读文件流是对文件进行流式读取的抽象。我们可以通过fs.createReadStream创建一个文件可读流。文件可读流继承于可读流，所以我们可以以可读流的方式使用它。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Writable</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;stream&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>class</span><span class=w> </span><span class=nx>DemoWritable</span><span class=w> </span><span class=k>extends</span><span class=w> </span><span class=nx>Writable</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>_write</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>encoding</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=nx>cb</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=s1>&#39;11111.md&#39;</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span><span class=ow>new</span><span class=w> </span><span class=nx>DemoWritable</span><span class=p>);</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>或者</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>readStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=s1>&#39;11111.md&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>readStream</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w>  </span>
<span class=w>    </span><span class=p>});</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>我们看一下createReadStream的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>ReadStream</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>CreateReadStream是对ReadStream的封装。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>ReadStream</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=k>this</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>ReadStream</span><span class=p>))</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>ReadStream</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>copyObject</span><span class=p>(</span><span class=nx>getOptions</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=p>{}));</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 可读流的阈值  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>highWaterMark</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=nx>options</span><span class=p>.</span><span class=nx>highWaterMark</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>64</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1024</span><span class=p>;</span><span class=w>  </span>

<span class=w>      </span><span class=nx>Readable</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=nx>handleError</span><span class=p>((</span><span class=k>this</span><span class=p>.</span><span class=nx>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getPathFromURL</span><span class=p>(</span><span class=nx>path</span><span class=p>)));</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 支持传文件路径或文件描述符  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>fd</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>flags</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>flags</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>mode</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=mo>0o666</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>mode</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 读取的开始和结束位置  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w>  </span>
<span class=w>        </span><span class=mf>0</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>start</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>end</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 流出错或结束时是否自动销毁流  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>autoClose</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>undefined</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 已读的字节数  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 流是否已经关闭  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 参数校验  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=ne>TypeError</span><span class=p>(</span><span class=s1>&#39;ERR_INVALID_ARG_TYPE&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=s1>&#39;start&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=s1>&#39;number&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 默认读取全部内容  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>Infinity</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=ne>TypeError</span><span class=p>(</span><span class=s1>&#39;ERR_INVALID_ARG_TYPE&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=s1>&#39;end&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=s1>&#39;number&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>

<span class=w>        </span><span class=c1>// 从文件的哪个位置开始读，start是开始位置，pos是当前位置，初始化等于开始位置  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 如果是根据一个文件名创建一个流，则首先打开这个文件  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>open</span><span class=p>();</span><span class=w>  </span>

<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 流结束时自动销毁流  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>ReadStream初始化完后做了两个操作，首先调用open打开文件（如果需要的话），接着监听流结束事件，用户可以设置autoClose选项控制当流结束或者出错时是否销毁流，对于文件流来说，销毁流意味着关闭地方文件描述符。我们接着看一下open的实现</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=c1>// 打开文件  </span>
<span class=w>    </span><span class=nx>ReadStream</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>open</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>self</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>mode</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>er</span><span class=p>,</span><span class=w> </span><span class=nx>fd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 发生错误，是否需要自动销毁流  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=nx>self</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span><span class=w>  </span>
<span class=w>          </span><span class=p>}</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// 通知用户  </span>
<span class=w>          </span><span class=nx>self</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>er</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>

<span class=w>        </span><span class=nx>self</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fd</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 触发open，一般用于Node.js内部逻辑  </span>
<span class=w>        </span><span class=nx>self</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;open&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>fd</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// start the flow of data.  </span>
<span class=w>        </span><span class=c1>// 打开成功后开始流式读取文件内容  </span>
<span class=w>        </span><span class=nx>self</span><span class=p>.</span><span class=nx>read</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>open函数首先打开文件，打开成功后开启流式读取。从而文件内容就会源源不断地流向目的流。我们继续看一下读取操作的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=c1>// 实现可读流的钩子函数  </span>
<span class=w>    </span><span class=nx>ReadStream</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_read</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 如果没有调用open而是直接调用该方法则先执行open  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;open&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>_read</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 流已经销毁则不处理  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>destroyed</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 判断池子空间是否足够，不够则申请新的  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>pool</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>pool</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>pool</span><span class=p>.</span><span class=nx>used</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nx>kMinPoolSpace</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// discard the old pool.  </span>
<span class=w>        </span><span class=nx>allocNewPool</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>readableHighWaterMark</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// 计算可读的最大数量  </span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>thisPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>pool</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/* </span>
<span class=cm>        可读取的最大值,取可用内存大小和Node.js打算读取的大小 </span>
<span class=cm>        中的小值,n不是用户想读取的大小，而是可读流内部的逻辑 </span>
<span class=cm>        见_stream_readable.js的this._read(state.highWaterMark) </span>
<span class=cm>      */</span><span class=w>  </span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>pool</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>pool</span><span class=p>.</span><span class=nx>used</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>pool</span><span class=p>.</span><span class=nx>used</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 已经读取了部分了，则计算剩下读取的大小，和计算读取的toRead比较取小值  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=nx>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mf>1</span><span class=p>,</span><span class=w> </span><span class=nx>toRead</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// 读结束  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>toRead</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// pool.used是即将读取的数据存储在pool中的开始位置，this.pos是从文件的哪个位置开始读取  </span>
<span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>read</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>pool</span><span class=p>,</span><span class=w> </span><span class=nx>pool</span><span class=p>.</span><span class=nx>used</span><span class=p>,</span><span class=w> </span><span class=nx>toRead</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>,</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span><span class=w>  </span>
<span class=w>          </span><span class=p>}</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>er</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=kd>var</span><span class=w> </span><span class=nx>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=c1>// 已读的字节数累加  </span>
<span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=nx>bytesRead</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>            </span><span class=c1>// 获取有效数据  </span>
<span class=w>            </span><span class=nx>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>thisPool</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>start</span><span class=p>,</span><span class=w> </span><span class=nx>start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>bytesRead</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=p>}</span><span class=w>  </span>
<span class=w>          </span><span class=c1>// push到底层流的bufferList中，底层的push会触发data事件  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// 重新设置已读指针的位置  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>toRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=nx>pool</span><span class=p>.</span><span class=nx>used</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>toRead</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>代码看起来很多，主要的逻辑是调用异步read函数读取文件的内容，然后放到可读流中，可读流会触发data事件通知用户有数据到来，然后继续执行read函数，从而不断驱动着数据的读取（可读流会根据当前情况判断是否继续执行read函数，以达到流量控制的目的）。最后我们看一下关闭和销毁一个文件流的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code>    ReadStream.prototype.close = function(cb) {  
      this.destroy(null, cb);  
    };  
</code></pre></div></td></tr></table></div> <p>当我们设置autoClose为false的时候，我们就需要自己手动调用close函数关闭可读文件流。关闭文件流很简单，就是正常地销毁流。我们看看销毁流的时候，Node.js做了什么。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=c1>// 关闭底层文件  </span>
<span class=w>    </span><span class=nx>ReadStream</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_destroy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>isOpen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>isOpen</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;open&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>closeFsStream</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>));</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=nx>closeFsStream</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>

<span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>closeFsStream</span><span class=p>(</span><span class=nx>stream</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>close</span><span class=p>(</span><span class=nx>stream</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=nx>er</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>er</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>err</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=nx>cb</span><span class=p>(</span><span class=nx>er</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=nx>stream</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>er</span><span class=p>)</span><span class=w>  </span>
<span class=w>          </span><span class=nx>stream</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>销毁文件流就是关闭底层的文件描述符。另外如果是因为发生错误导致销毁或者关闭文件描述符错误则不会触发close事件。</p> <h3 id=1252>12.5.2 可写文件流<a class=headerlink href=#1252 title="Permanent link">&para;</a></h3> <p>可写文件流是对文件进行流式写入的抽象。我们可以通过fs.createWriteStream创建一个文件可写流。文件可些流继承于可写流，所以我们可以以可写流的方式使用它。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>writeStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>);</span>
<span class=w>    </span><span class=nx>writeStream</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;world&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=c1>// 或者</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Readable</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;stream&#39;</span><span class=p>);</span><span class=w>  </span>

<span class=w>    </span><span class=kd>class</span><span class=w> </span><span class=nx>DemoReadStream</span><span class=w> </span><span class=k>extends</span><span class=w> </span><span class=nx>Readable</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=kr>constructor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=k>super</span><span class=p>();</span><span class=w>  </span>
<span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=nx>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=nx>_read</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=nx>i</span><span class=o>++</span><span class=p>;</span><span class=w>  </span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>i</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>10</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>  </span>
<span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>.</span><span class=nx>repeat</span><span class=p>(</span><span class=nx>n</span><span class=p>));</span><span class=w>  </span>
<span class=w>            </span><span class=p>}</span><span class=w>  </span>

<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
<span class=w>    </span><span class=ow>new</span><span class=w> </span><span class=nx>DemoReadStream</span><span class=p>().</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>));</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>我们看一下createWriteStream的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WriteStream</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>createWriteStream是对WriteStream的封装，我们看一下WriteStream的实现</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>function</span><span class=w> </span><span class=nx>WriteStream</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=k>this</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>WriteStream</span><span class=p>))</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>WriteStream</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>copyObject</span><span class=p>(</span><span class=nx>getOptions</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span><span class=w> </span><span class=p>{}));</span><span class=w>  </span>

<span class=w>      </span><span class=nx>Writable</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>);</span><span class=w>  </span>

<span class=w>      </span><span class=nx>handleError</span><span class=p>((</span><span class=k>this</span><span class=p>.</span><span class=nx>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getPathFromURL</span><span class=p>(</span><span class=nx>path</span><span class=p>)));</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>fd</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>flags</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;w&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>flags</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>mode</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=mo>0o666</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>mode</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 写入的开始位置  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>start</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 流结束和触发错误的时候是否销毁流  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>autoClose</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=kc>undefined</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 当前写入位置  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>undefined</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 写成功的字节数  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>bytesWritten</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=ne>TypeError</span><span class=p>(</span><span class=s1>&#39;ERR_INVALID_ARG_TYPE&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=s1>&#39;start&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=s1>&#39;number&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                     </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=kd>const</span><span class=w> </span><span class=nx>errVal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`{start: </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=si>}</span><span class=sb>}`</span><span class=p>;</span><span class=w>  </span>
<span class=w>          </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=ne>RangeError</span><span class=p>(</span><span class=s1>&#39;ERR_OUT_OF_RANGE&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                      </span><span class=s1>&#39;start&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                      </span><span class=s1>&#39;&gt;= 0&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                      </span><span class=nx>errVal</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 记录写入的开始位置  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>start</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>setDefaultEncoding</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>encoding</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 没有传文件描述符则打开一个新的文件  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>open</span><span class=p>();</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// 监听可写流的finish事件，判断是否需要执行销毁操作  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;finish&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>
<span class=w>    </span><span class=p>}</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>WriteStream初始化了一系列字段后，如果传的是文件路径则打开文件，如果传的文件描述符则不需要再次打开文件。后续对文件可写流的操作就是对文件描述符的操作。我们首先看一下写入文件的逻辑。我们知道可写流只是实现了一些抽象的逻辑，具体的写逻辑是具体的流通过_write或者_writev实现的，我们看一下_write的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=nx>WriteStream</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_write</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>encoding</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>data</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>Buffer</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=ne>TypeError</span><span class=p>(</span><span class=s1>&#39;ERR_INVALID_ARG_TYPE&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                         </span><span class=s1>&#39;data&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                         </span><span class=s1>&#39;Buffer&#39;</span><span class=p>,</span><span class=w>  </span>
<span class=w>                                         </span><span class=nx>data</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 还没打开文件，则等待打开成功后再执行写操作  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;open&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>_write</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>encoding</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 执行写操作,0代表从data的哪个位置开始写，这里是全部写入，所以是0，pos代表文件的位置  </span>
<span class=w>      </span><span class=nx>fs</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>,</span><span class=w> </span><span class=nx>bytes</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span><span class=w>  </span>
<span class=w>          </span><span class=p>}</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=nx>cb</span><span class=p>(</span><span class=nx>er</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 写入成功的字节长度  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>bytesWritten</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>bytes</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=nx>cb</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 下一个写入的位置  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>data</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>_write就是根据用户传入数据的大小，不断调用fs.write往底层写入数据，直到写完成或者出错。接着我们看一下批量写的逻辑。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=c1>// 实现可写流批量写钩子  </span>
<span class=w>    </span><span class=nx>WriteStream</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_writev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=ow>typeof</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s1>&#39;number&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>once</span><span class=p>(</span><span class=s1>&#39;open&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>_writev</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>self</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>data</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>chunks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Array</span><span class=p>(</span><span class=nx>len</span><span class=p>);</span><span class=w>  </span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=nx>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 计算待写入的出总大小，并且把数据保存到chunk数组中，准备写入  </span>
<span class=w>      </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>var</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nx>len</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>chunk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>chunk</span><span class=p>;</span><span class=w>  </span>

<span class=w>        </span><span class=nx>chunks</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>chunk</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=nx>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>chunk</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 执行批量写  </span>
<span class=w>      </span><span class=nx>writev</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>fd</span><span class=p>,</span><span class=w> </span><span class=nx>chunks</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>er</span><span class=p>,</span><span class=w> </span><span class=nx>bytes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>er</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=nx>self</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=nx>cb</span><span class=p>(</span><span class=nx>er</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>        </span><span class=c1>// 写成功的字节数，可能小于希望写入的字节数  </span>
<span class=w>        </span><span class=nx>self</span><span class=p>.</span><span class=nx>bytesWritten</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>bytes</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=nx>cb</span><span class=p>();</span><span class=w>  </span>
<span class=w>      </span><span class=p>});</span><span class=w>  </span>
<span class=w>      </span><span class=cm>/* </span>
<span class=cm>        更新下一个写入位置，如果写部分成功，计算下一个写入位置时 </span>
<span class=cm>        也会包括没写成功的字节数，所以是假设size而不是bytes </span>
<span class=cm>      */</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>undefined</span><span class=p>)</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>size</span><span class=p>;</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>批量写入的逻辑和_write类似，只不过它调用的是不同的接口往底层写。接下来我们看关闭文件可写流的实现。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=nx>WriteStream</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>close</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>function</span><span class=p>(</span><span class=nx>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>      </span><span class=c1>// 关闭文件成功后执行的回调  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>closed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=nx>process</span><span class=p>.</span><span class=nx>nextTick</span><span class=p>(</span><span class=nx>cb</span><span class=p>);</span><span class=w>  </span>
<span class=w>          </span><span class=k>return</span><span class=p>;</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>cb</span><span class=p>);</span><span class=w>  </span>
<span class=w>        </span><span class=p>}</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=cm>/* </span>
<span class=cm>        如果autoClose是false，说明流结束触发finish事件时，不会销毁流，</span>
<span class=cm>        见WriteStream初始化代码 以这里需要监听finish事件，保证可写流结束时可以关闭文件描述符 </span>
<span class=cm>      */</span><span class=w>  </span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>autoClose</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;finish&#39;</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>destroy</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>));</span><span class=w>  </span>
<span class=w>      </span><span class=p>}</span><span class=w>  </span>

<span class=w>      </span><span class=c1>// 结束流，会触发finish事件  </span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span><span class=w>  </span>
<span class=w>    </span><span class=p>};</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>可写文件流和可读文件流不一样。默认情况下，可读流在读完文件内容后Node.js会自动销毁流（关闭文件描述符），而写入文件，在某些情况下Node.js是无法知道什么时候流结束的，这需要我们显式地通知Node.js。在下面的例子中，我们是不需要显式通知Node.js的 fs.createReadStream('11111.md').pipe(fs.createWriteStream('123.md'));<br> 因为可读文件流在文件读完后会调用可写文件的end方法，从而关闭可读流和可写流对应的文件描述符。而在以下代码中情况就变得复杂。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>stream</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=c1>// stream.close 或 stream.end();</span>
</code></pre></div></td></tr></table></div> <p>在默认情况，我们可以调用end或者close去通知Node.js流结束。但是如果我们设置了autoClose为false，那么我们只能调用close而不能调用end。否则会造成文件描述符泄漏。因为end只是关闭了流。但是没有触发销毁流的逻辑。而close会触发销毁流的逻辑。我们看一下具体的代码。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>stream</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=c1>// 防止进程退出  </span>
<span class=w>    </span><span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{});</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>以上代码会导致文件描述符泄漏，我们在Linux下执行以下代码，通过ps aux找到进程id，然后执行lsof -p pid就可以看到进程打开的所有文件描述符。输出如12-6所示。<br> <img alt src=https://img-blog.csdnimg.cn/d2697f5c3b29454aa53e20fc064d17ef.png><br> 图12-6</p> <p>文件描述符17指向了123.md文件。所以文件描述符没有被关闭，引起文件描述符泄漏。我们修改一下代码。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>stream</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{});</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> 下面是以上代码的输出，我们看到没有123.md对应的文件描述符，如图12-7所示。<br> <img alt src=https://img-blog.csdnimg.cn/da6c69dde9424e5e9897b90462eeb300.png><br> 图12-7<br> 我们继续修改代码 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=nx>autoClose</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>});</span><span class=w>  </span>
<span class=w>    </span><span class=nx>stream</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{});</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> 以上代码的输出如图12-8所示。<br> <img alt src=https://img-blog.csdnimg.cn/459575d162e043f1a85c81797f413977.png><br> 图12-8<br> 我们看到使用end也无法关闭文件描述符。继续修改。</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span><span class=w>  </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;123.md&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=nx>autoClose</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>})</span>
<span class=w>    </span><span class=nx>stream</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span><span class=w>  </span>
<span class=w>    </span><span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{});</span><span class=w>  </span>
</code></pre></div></td></tr></table></div> <p>以上代码的输出如图12-9所示。<br> <img alt src=https://img-blog.csdnimg.cn/e4fbadd8aed043a49902148d8058485a.png><br> 图12-9<br> 我们看到成功关闭了文件描述符。</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021 theanarkh </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/theanarkh target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.zhihu.com/people/theanarkh target=_blank rel=noopener title=www.zhihu.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../assets/javascripts/bundle.83f73b43.min.js></script> <script src=../extra/image.js defer></script> </body> </html>