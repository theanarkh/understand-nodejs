<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="通过源码分析 Node.js 原理"><meta name=author content=theanarkh><link href=https://github.com/theanarkh/understand-nodejs/chapter25-Node.js%E5%AD%90%E7%BA%BF%E7%A8%8B%E8%B0%83%E8%AF%95%E5%92%8C%E8%AF%8A%E6%96%AD%E6%8C%87%E5%8D%97/ rel=canonical><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.44"><title>chapter25 Node.js子线程调试和诊断指南 - Node.js 源码剖析</title><link rel=stylesheet href=../assets/stylesheets/main.0253249f.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-inspector class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=.. title="Node.js 源码剖析" class="md-header__button md-logo" aria-label="Node.js 源码剖析" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Node.js 源码剖析 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> chapter25 Node.js子线程调试和诊断指南 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/theanarkh/understand-nodejs title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> understand-nodejs </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../chapter00-%E5%89%8D%E8%A8%80/ class=md-tabs__link> 前言 </a> </li> <li class=md-tabs__item> <a href=../chapter01-Node.js%E7%BB%84%E6%88%90%E5%92%8C%E5%8E%9F%E7%90%86/ class=md-tabs__link> Node.js基础和架构 </a> </li> <li class=md-tabs__item> <a href=../chapter07-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/ class=md-tabs__link> Node.js核心模块的实现 </a> </li> <li class=md-tabs__item> <a href=../chapter20-%E6%8B%93%E5%B1%95Node.js/ class=md-tabs__link> 其他 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Node.js 源码剖析" class="md-nav__button md-logo" aria-label="Node.js 源码剖析" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg> </a> Node.js 源码剖析 </label> <div class=md-nav__source> <a href=https://github.com/theanarkh/understand-nodejs title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> understand-nodejs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../chapter00-%E5%89%8D%E8%A8%80/ class=md-nav__link> <span class=md-ellipsis> 前言 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Node.js基础和架构 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Node.js基础和架构 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter01-Node.js%E7%BB%84%E6%88%90%E5%92%8C%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 01-Node.js组成和原理 </span> </a> </li> <li class=md-nav__item> <a href=../chapter02-Libuv%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E9%80%9A%E7%94%A8%E9%80%BB%E8%BE%91/ class=md-nav__link> <span class=md-ellipsis> 02-Libuv数据结构和通用逻辑 </span> </a> </li> <li class=md-nav__item> <a href=../chapter03-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/ class=md-nav__link> <span class=md-ellipsis> 03-事件循环 </span> </a> </li> <li class=md-nav__item> <a href=../chapter04-%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> <span class=md-ellipsis> 04-线程池 </span> </a> </li> <li class=md-nav__item> <a href=../chapter05-Libuv%E6%B5%81/ class=md-nav__link> <span class=md-ellipsis> 05-Libuv流 </span> </a> </li> <li class=md-nav__item> <a href=../chapter06-C%2B%2B%E5%B1%82/ class=md-nav__link> <span class=md-ellipsis> 06-C++层 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Node.js核心模块的实现 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Node.js核心模块的实现 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter07-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 07-信号处理 </span> </a> </li> <li class=md-nav__item> <a href=../chapter08-DNS/ class=md-nav__link> <span class=md-ellipsis> 08-DNS </span> </a> </li> <li class=md-nav__item> <a href=../chapter09-Unix%E5%9F%9F/ class=md-nav__link> <span class=md-ellipsis> 09-Unix域 </span> </a> </li> <li class=md-nav__item> <a href=../chapter10-%E5%AE%9A%E6%97%B6%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> 10-定时器 </span> </a> </li> <li class=md-nav__item> <a href=../chapter11-setImmediate%E5%92%8CnextTick/ class=md-nav__link> <span class=md-ellipsis> 11-setImmediate和nextTick </span> </a> </li> <li class=md-nav__item> <a href=../chapter12-%E6%96%87%E4%BB%B6/ class=md-nav__link> <span class=md-ellipsis> 12-文件 </span> </a> </li> <li class=md-nav__item> <a href=../chapter13-%E8%BF%9B%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 13-进程 </span> </a> </li> <li class=md-nav__item> <a href=../chapter14-%E7%BA%BF%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 14-线程 </span> </a> </li> <li class=md-nav__item> <a href=../chapter15-Cluster/ class=md-nav__link> <span class=md-ellipsis> 15-Cluster </span> </a> </li> <li class=md-nav__item> <a href=../chapter16-UDP/ class=md-nav__link> <span class=md-ellipsis> 16-UDP </span> </a> </li> <li class=md-nav__item> <a href=../chapter17-TCP/ class=md-nav__link> <span class=md-ellipsis> 17-TCP </span> </a> </li> <li class=md-nav__item> <a href=../chapter18-HTTP/ class=md-nav__link> <span class=md-ellipsis> 18-HTTP </span> </a> </li> <li class=md-nav__item> <a href=../chapter19-%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> 19-模块加载 </span> </a> </li> <li class=md-nav__item> <a href=../chapter21-JS%20Stream/ class=md-nav__link> <span class=md-ellipsis> 20-JS Stream </span> </a> </li> <li class=md-nav__item> <a href=../chapter22-events%E6%A8%A1%E5%9D%97/ class=md-nav__link> <span class=md-ellipsis> 21-events模块 </span> </a> </li> <li class=md-nav__item> <a href=../chapter23-Async%20hooks/ class=md-nav__link> <span class=md-ellipsis> 22-Async hooks </span> </a> </li> <li class=md-nav__item> <a href=../chapter24-Inspector/ class=md-nav__link> <span class=md-ellipsis> 23-Inspector </span> </a> </li> <li class=md-nav__item> <a href=../chapter27-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Node.js%20%E7%9A%84%20Buffer/ class=md-nav__link> <span class=md-ellipsis> 27-深入理解 Node.js 的 Buffer </span> </a> </li> <li class=md-nav__item> <a href=../chapter30-Node.js%20%E7%9A%84%20trace%20events%20%E6%9E%B6%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 30-Node.js 的 trace events 架构 </span> </a> </li> <li class=md-nav__item> <a href=../chapter31-Node.js%20%E7%9A%84%20perf_hooks/ class=md-nav__link> <span class=md-ellipsis> 31-Node.js 的 perf_hooks </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> 其他 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter20-%E6%8B%93%E5%B1%95Node.js/ class=md-nav__link> <span class=md-ellipsis> 24-拓展Node.js </span> </a> </li> <li class=md-nav__item> <a href=../chapter25-Node.js子线程调试和诊断指南 class=md-nav__link> <span class=md-ellipsis> 25-Node.js子线程调试和诊断指南 </span> </a> </li> <li class=md-nav__item> <a href=../chapter26-vscode%E8%B0%83%E8%AF%95Node.js/ class=md-nav__link> <span class=md-ellipsis> 26-vscode调试Node.js </span> </a> </li> <li class=md-nav__item> <a href=../chapter28-Node.js%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88%E6%9E%B6%E6%9E%84%E7%AF%87%EF%BC%89/ class=md-nav__link> <span class=md-ellipsis> 28-Node.js底层原理（架构篇） </span> </a> </li> <li class=md-nav__item> <a href=../chapter29-Node.js%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88%E5%AE%9E%E7%8E%B0%E7%AF%87%EF%BC%89/ class=md-nav__link> <span class=md-ellipsis> 29-Node.js底层原理（实现篇） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <p>调试、诊断子线程最直接的方式就是像调试、诊断主线程一样，但是无论是动态开启还是静态开启，子线程都不可避免地需要内置一些相关的非业务代码，本文介绍另外一种对子线程代码无侵入的调试方式，另外也介绍一下通过子线程调试主线程的方式。</p> <h1 id=1-inspector>1 初始化子线程的Inspector<a class=headerlink href=#1-inspector title="Permanent link">&para;</a></h1> <p>在Node.js启动子线程的时候，会初始化Inspector。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>env_</span><span class=o>-&gt;</span><span class=n>InitializeInspector</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>inspector_parent_handle_</span><span class=p>));</span>
</code></pre></div></td></tr></table></div> 在分析InitializeInspector之前，我们先看一下inspector_parent_handle_。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>inspector</span><span class=o>::</span><span class=n>ParentInspectorHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>inspector_parent_handle_</span><span class=p>;</span>
</code></pre></div></td></tr></table></div> inspector_parent_handle_是一个ParentInspectorHandle对象，这个对象是子线程和主线程通信的桥梁。我们看一下他的初始化逻辑（在主线程里执行）。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>inspector_parent_handle_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>inspector_agent</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>GetParentHandle</span><span class=p>(</span><span class=n>thread_id_</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> 调用agent的GetParentHandle获取一个ParentInspectorHandle对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>ParentInspectorHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>Agent</span><span class=o>::</span><span class=n>GetParentHandle</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>thread_id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>client_</span><span class=o>-&gt;</span><span class=n>getWorkerManager</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>NewParentHandle</span><span class=p>(</span><span class=n>thread_id</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 内部其实是通过client_-&gt;getWorkerManager()对象的NewParentHandle方法获取ParentInspectorHandle对象，接下来我们看一下WorkerManager的NewParentHandle。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>ParentInspectorHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>WorkerManager</span><span class=o>::</span><span class=n>NewParentHandle</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>thread_id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=kt>bool</span><span class=w> </span><span class=n>wait</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>delegates_waiting_on_start_</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>ParentInspectorHandle</span><span class=o>&gt;</span><span class=p>(</span><span class=n>thread_id</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>thread_</span><span class=p>,</span><span class=w> </span><span class=n>wait</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>ParentInspectorHandle</span><span class=o>::</span><span class=n>ParentInspectorHandle</span><span class=p>(</span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>url</span><span class=p>,</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MainThreadHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>parent_thread</span><span class=p>,</span><span class=w> </span>
<span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>wait_for_connect</span>
<span class=p>)</span>
<span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>id_</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w> </span>
<span class=w>      </span><span class=n>url_</span><span class=p>(</span><span class=n>url</span><span class=p>),</span><span class=w> </span>
<span class=w>      </span><span class=n>parent_thread_</span><span class=p>(</span><span class=n>parent_thread</span><span class=p>),</span>
<span class=w>      </span><span class=n>wait_</span><span class=p>(</span><span class=n>wait_for_connect</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
</code></pre></div></td></tr></table></div> 最终的架构图如下入所示。 <img alt src="https://img-blog.csdnimg.cn/bcd42b781c5446919df9cc16b9f04ebf.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 分析完ParentInspectorHandle后继续看一下env_-&gt;InitializeInspector(std::move(inspector_parent_handle_))的逻辑（在子线程里执行）。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=nf>Environment::InitializeInspector</span><span class=p>(</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>inspector</span><span class=o>::</span><span class=n>ParentInspectorHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>parent_handle</span><span class=p>)</span><span class=w> </span><span class=p>{</span>

<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>inspector_path</span><span class=p>;</span>
<span class=w>  </span><span class=n>inspector_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent_handle</span><span class=o>-&gt;</span><span class=n>url</span><span class=p>();</span>
<span class=w>  </span><span class=n>inspector_agent_</span><span class=o>-&gt;</span><span class=n>SetParentHandle</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>parent_handle</span><span class=p>));</span>
<span class=w>  </span><span class=n>inspector_agent_</span><span class=o>-&gt;</span><span class=n>Start</span><span class=p>(</span><span class=n>inspector_path</span><span class=p>,</span>
<span class=w>                          </span><span class=n>options_</span><span class=o>-&gt;</span><span class=n>debug_options</span><span class=p>(),</span>
<span class=w>                          </span><span class=n>inspector_host_port</span><span class=p>(),</span>
<span class=w>                          </span><span class=n>is_main_thread</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 首先把ParentInspectorHandle对象保存到agent中，然后调用agent的Start方法。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>bool</span><span class=w> </span><span class=nf>Agent::Start</span><span class=p>(...)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=c1>// 新建client对象</span>
<span class=w>   </span><span class=n>client_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>NodeInspectorClient</span><span class=o>&gt;</span><span class=p>(</span><span class=n>parent_env_</span><span class=p>,</span><span class=w> </span><span class=n>is_main</span><span class=p>);</span>
<span class=w>   </span><span class=c1>// 调用agent中保存的ParentInspectorHandle对象的WorkerStarted</span>
<span class=w>   </span><span class=n>parent_handle_</span><span class=o>-&gt;</span><span class=n>WorkerStarted</span><span class=p>(</span><span class=n>client_</span><span class=o>-&gt;</span><span class=n>getThreadHandle</span><span class=p>(),</span><span class=w> </span><span class=p>...);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> Agent::Start创建了一个client对象，然后调用ParentInspectorHandle对象的WorkerStarted方法（刚才SetParentHandle的时候保存的），我们看一下这时候的架构图。 <img alt src="https://img-blog.csdnimg.cn/6a355ff65a934af7a728824968ea3afc.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 接着看parent_handle_-&gt;WorkerStarted。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>ParentInspectorHandle::WorkerStarted</span><span class=p>(</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MainThreadHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>worker_thread</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>waiting</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Request</span><span class=o>&gt;</span><span class=w> </span><span class=n>request</span><span class=p>(</span>
<span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>WorkerStartedRequest</span><span class=p>(</span><span class=n>id_</span><span class=p>,</span><span class=w> </span><span class=n>url_</span><span class=p>,</span><span class=w> </span><span class=n>worker_thread</span><span class=p>,</span><span class=w> </span><span class=n>waiting</span><span class=p>));</span>
<span class=w>  </span><span class=n>parent_thread_</span><span class=o>-&gt;</span><span class=n>Post</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>request</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> WorkerStarted创建了一个WorkerStartedRequest请求，然后通过parent_thread_-&gt;Post提交，parent_thread_是MainThreadInterface对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>MainThreadInterface::Post</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Request</span><span class=o>&gt;</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>Mutex</span><span class=o>::</span><span class=n>ScopedLock</span><span class=w> </span><span class=n>scoped_lock</span><span class=p>(</span><span class=n>requests_lock_</span><span class=p>);</span>
<span class=w>  </span><span class=c1>// 之前是空则需要唤醒消费者</span>
<span class=w>  </span><span class=kt>bool</span><span class=w> </span><span class=n>needs_notify</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requests_</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span>
<span class=w>  </span><span class=c1>// 消息入队</span>
<span class=w>  </span><span class=n>requests_</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>request</span><span class=p>));</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>needs_notify</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>       </span><span class=c1>// 获取当前对象的一个弱引用</span>
<span class=w>       </span><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>MainThreadInterface</span><span class=o>&gt;*</span><span class=w> </span><span class=n>interface_ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>MainThreadInterface</span><span class=o>&gt;</span><span class=p>(</span><span class=n>shared_from_this</span><span class=p>());</span>
<span class=w>      </span><span class=c1>// 请求V8执行RequestInterrupt入参对应的回调</span>
<span class=w>      </span><span class=n>isolate_</span><span class=o>-&gt;</span><span class=n>RequestInterrupt</span><span class=p>([](</span><span class=n>v8</span><span class=o>::</span><span class=n>Isolate</span><span class=o>*</span><span class=w> </span><span class=n>isolate</span><span class=p>,</span><span class=w> </span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>opaque</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=c1>// 把执行时传入的参数转成MainThreadInterface</span>
<span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>MainThreadInterface</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>interface_ptr</span><span class=w> </span><span class=p>{</span>
<span class=w>          </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>weak_ptr</span><span class=o>&lt;</span><span class=n>MainThreadInterface</span><span class=o>&gt;*&gt;</span><span class=p>(</span><span class=n>opaque</span><span class=p>)</span><span class=w> </span>
<span class=w>        </span><span class=p>};</span>
<span class=w>        </span><span class=c1>// 判断对象是否还有效，是则调用DispatchMessages</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>auto</span><span class=w> </span><span class=n>iface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>interface_ptr</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>())</span><span class=w> </span><span class=n>iface</span><span class=o>-&gt;</span><span class=n>DispatchMessages</span><span class=p>();</span>

<span class=w>      </span><span class=p>},</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>void</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>interface_ptr</span><span class=p>));</span>
<span class=w>  </span><span class=p>}</span>
<span class=w>  </span><span class=c1>// 唤醒消费者</span>
<span class=w>  </span><span class=n>incoming_message_cond_</span><span class=p>.</span><span class=n>Broadcast</span><span class=p>(</span><span class=n>scoped_lock</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 我们看看这时候的架构图。 <img alt src="https://img-blog.csdnimg.cn/58c87d7fa58d448693147af38566a4e2.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 接着看回调里执行MainThreadInterface对象DispatchMessages方法的逻辑。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>MainThreadInterface::DispatchMessages</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// 遍历请求队列</span>
<span class=w>  </span><span class=n>requests_</span><span class=p>.</span><span class=n>swap</span><span class=p>(</span><span class=n>dispatching_message_queue_</span><span class=p>);</span>
<span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>dispatching_message_queue_</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>MessageQueue</span><span class=o>::</span><span class=n>value_type</span><span class=w> </span><span class=n>task</span><span class=p>;</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>swap</span><span class=p>(</span><span class=n>dispatching_message_queue_</span><span class=p>.</span><span class=n>front</span><span class=p>(),</span><span class=w> </span><span class=n>task</span><span class=p>);</span>
<span class=w>    </span><span class=n>dispatching_message_queue_</span><span class=p>.</span><span class=n>pop_front</span><span class=p>();</span>
<span class=w>    </span><span class=c1>// 执行任务函数</span>
<span class=w>    </span><span class=n>task</span><span class=o>-&gt;</span><span class=n>Call</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> task是WorkerStartedRequest对象，看一下Call方法的代码。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>Call</span><span class=p>(</span><span class=n>MainThreadInterface</span><span class=o>*</span><span class=w> </span><span class=kr>thread</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>inspector_agent</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>GetWorkerManager</span><span class=p>();</span>
<span class=w>  </span><span class=n>manager</span><span class=o>-&gt;</span><span class=n>WorkerStarted</span><span class=p>(</span><span class=n>id_</span><span class=p>,</span><span class=w> </span><span class=n>info_</span><span class=p>,</span><span class=w> </span><span class=n>waiting_</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 接着调用agent的WorkerManager的WorkerStarted。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>WorkerManager::WorkerStarted</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>session_id</span><span class=p>,</span>
<span class=w>                                  </span><span class=k>const</span><span class=w> </span><span class=n>WorkerInfo</span><span class=o>&amp;</span><span class=w> </span><span class=n>info</span><span class=p>,</span>
<span class=w>                                  </span><span class=kt>bool</span><span class=w> </span><span class=n>waiting</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>children_</span><span class=p>.</span><span class=n>emplace</span><span class=p>(</span><span class=n>session_id</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>);</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>delegate</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>delegates_</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>Report</span><span class=p>(</span><span class=n>delegate</span><span class=p>.</span><span class=n>second</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=n>waiting</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> WorkerStarted记录了一个id和上下文，因为delegates_初始化的时候是空的，所以不会执行。至此，子线程Inspector初始化的逻辑就分析完了，结构图如下。 <img alt src="https://img-blog.csdnimg.cn/2e92c9a37fb145fdbe49e615e9fdd465.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 我们发现，和主线程不一样，主线程会启动一个WebSocket服务器接收客户端的连接请求，而子线程只是初始化了一些数据结构。下面我们看一下基于这些数据结构，主线程是如何动态开启调试子线程的。</p> <h1 id=2>2 主线程开启调试子线程的能力<a class=headerlink href=#2 title="Permanent link">&para;</a></h1> <p>我们可以以以下方式开启对子线程的调试。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Worker</span><span class=p>,</span><span class=w> </span><span class=nx>workerData</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;worker_threads&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Session</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;inspector&#39;</span><span class=p>);</span>
<span class=c1>// 新建一个新的通信通道</span>
<span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Session</span><span class=p>();</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
<span class=c1>// 创建子线程</span>
<span class=kd>const</span><span class=w> </span><span class=nx>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;./httpServer.js&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=nx>workerData</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=mf>80</span><span class=p>}});</span><span class=w> </span>
<span class=c1>// 子线程启动成功后开启调试子线程的能力</span>
<span class=nx>worker</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;online&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&quot;NodeWorker.enable&quot;</span><span class=p>,</span>
<span class=w>                 </span><span class=p>{</span><span class=nx>waitForDebuggerOnStart</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>},</span><span class=w>  </span>
<span class=w>                 </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span>
<span class=w>                    </span><span class=nx>err</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;NodeWorker.enable&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>);</span>
<span class=w>                 </span><span class=p>});</span>
<span class=p>});</span>
<span class=c1>// 防止主线程退出</span>
<span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=mf>100000</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> 我们先来分析一下connect函数的逻辑。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w> </span><span class=nx>connect</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>this</span><span class=p>[</span><span class=nx>connectionSymbol</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Connection</span><span class=p>((</span><span class=nx>message</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=k>this</span><span class=p>[</span><span class=nx>onMessageSymbol</span><span class=p>](</span><span class=nx>message</span><span class=p>));</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 新建了一个Connection对象并传入一个回调函数，该回调函数在收到消息时被回调。Connection是C++层导出的对象，由模版类JSBindingsConnection实现。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>ConnectionType</span><span class=o>&gt;</span>
<span class=k>class</span><span class=w> </span><span class=nc>JSBindingsConnection</span><span class=w> </span><span class=p>{}</span>
</code></pre></div></td></tr></table></div> 我们看看导出的路逻辑。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>JSBindingsConnection</span><span class=o>&lt;</span><span class=n>Connection</span><span class=o>&gt;::</span><span class=n>Bind</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> 接着看Bind。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>Bind</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=c1>// class_name是Connection</span>
<span class=w>    </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>class_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ConnectionType</span><span class=o>::</span><span class=n>GetClassName</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
<span class=w>    </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>FunctionTemplate</span><span class=o>&gt;</span><span class=w> </span><span class=n>tmpl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>NewFunctionTemplate</span><span class=p>(</span><span class=n>JSBindingsConnection</span><span class=o>::</span><span class=n>New</span><span class=p>);</span>
<span class=w>    </span><span class=n>tmpl</span><span class=o>-&gt;</span><span class=n>InstanceTemplate</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>SetInternalFieldCount</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
<span class=w>    </span><span class=n>tmpl</span><span class=o>-&gt;</span><span class=n>SetClassName</span><span class=p>(</span><span class=n>class_name</span><span class=p>);</span>
<span class=w>    </span><span class=n>tmpl</span><span class=o>-&gt;</span><span class=n>Inherit</span><span class=p>(</span><span class=n>AsyncWrap</span><span class=o>::</span><span class=n>GetConstructorTemplate</span><span class=p>(</span><span class=n>env</span><span class=p>));</span>
<span class=w>    </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>SetProtoMethod</span><span class=p>(</span><span class=n>tmpl</span><span class=p>,</span><span class=w> </span><span class=s>&quot;dispatch&quot;</span><span class=p>,</span><span class=w> </span><span class=n>JSBindingsConnection</span><span class=o>::</span><span class=n>Dispatch</span><span class=p>);</span>
<span class=w>    </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>SetProtoMethod</span><span class=p>(</span><span class=n>tmpl</span><span class=p>,</span><span class=w> </span><span class=s>&quot;disconnect&quot;</span><span class=p>,</span><span class=w> </span><span class=n>JSBindingsConnection</span><span class=o>::</span><span class=n>Disconnect</span><span class=p>);</span>
<span class=w>    </span><span class=n>target</span><span class=o>-&gt;</span><span class=n>Set</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>(),</span>
<span class=w>                </span><span class=n>class_name</span><span class=p>,</span>
<span class=w>                </span><span class=n>tmpl</span><span class=o>-&gt;</span><span class=n>GetFunction</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>()).</span><span class=n>ToLocalChecked</span><span class=p>())</span>
<span class=w>        </span><span class=p>.</span><span class=n>ToChecked</span><span class=p>();</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 当我们在JS层执行new Connection的时候，就会执行JSBindingsConnection::New。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w> </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>New</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>FunctionCallbackInfo</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>info</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>   </span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Environment</span><span class=o>::</span><span class=n>GetCurrent</span><span class=p>(</span><span class=n>info</span><span class=p>);</span>
<span class=w>   </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>Function</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>info</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>As</span><span class=o>&lt;</span><span class=n>Function</span><span class=o>&gt;</span><span class=p>();</span>
<span class=w>   </span><span class=k>new</span><span class=w> </span><span class=n>JSBindingsConnection</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=n>This</span><span class=p>(),</span><span class=w> </span><span class=n>callback</span><span class=p>);</span>
<span class=w> </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 我们看看新建一个JSBindingsConnection对象时的逻辑。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>JSBindingsConnection</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span>
<span class=w>                       </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>wrap</span><span class=p>,</span>
<span class=w>                       </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>Function</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span>
<span class=w>                       </span><span class=o>:</span><span class=w> </span><span class=n>AsyncWrap</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>wrap</span><span class=p>,</span><span class=w> </span><span class=n>PROVIDER_INSPECTORJSBINDING</span><span class=p>),</span>
<span class=w>                         </span><span class=n>callback_</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>isolate</span><span class=p>(),</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>Agent</span><span class=o>*</span><span class=w> </span><span class=n>inspector</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>inspector_agent</span><span class=p>();</span>
<span class=w>    </span><span class=n>session_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocalConnection</span><span class=o>::</span><span class=n>Connect</span><span class=p>(</span>
<span class=w>        </span><span class=n>inspector</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>JSBindingsSessionDelegate</span><span class=o>&gt;</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>)</span>
<span class=w>    </span><span class=p>);</span>
<span class=p>}</span>

<span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSession</span><span class=o>&gt;</span><span class=w> </span><span class=n>Connect</span><span class=p>(</span>
<span class=w>      </span><span class=n>Agent</span><span class=o>*</span><span class=w> </span><span class=n>inspector</span><span class=p>,</span><span class=w> </span>
<span class=w>      </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSessionDelegate</span><span class=o>&gt;</span><span class=w> </span><span class=n>delegate</span>
<span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>inspector</span><span class=o>-&gt;</span><span class=n>Connect</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>delegate</span><span class=p>),</span><span class=w> </span><span class=nb>false</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 最终是传入了一个JSBindingsSessionDelegate对象调用Agent的Connect方法。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSession</span><span class=o>&gt;</span><span class=w> </span><span class=n>Agent</span><span class=o>::</span><span class=n>Connect</span><span class=p>(</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSessionDelegate</span><span class=o>&gt;</span><span class=w> </span><span class=n>delegate</span><span class=p>,</span>
<span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>prevent_shutdown</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>session_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client_</span><span class=o>-&gt;</span><span class=n>connectFrontend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>delegate</span><span class=p>),</span>
<span class=w>                                            </span><span class=n>prevent_shutdown</span><span class=p>);</span>
<span class=w>  </span><span class=c1>// JSBindingsConnection对象的session_字段指向的对象                                         </span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSession</span><span class=o>&gt;</span><span class=p>(</span>
<span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>SameThreadInspectorSession</span><span class=p>(</span><span class=n>session_id</span><span class=p>,</span><span class=w> </span><span class=n>client_</span><span class=p>)</span>
<span class=w>  </span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> Agent的Connect方法继续调用client_-&gt;connectFrontend。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=nf>connectFrontend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSessionDelegate</span><span class=o>&gt;</span><span class=w> </span><span class=n>delegate</span><span class=p>,</span>
<span class=w>                      </span><span class=kt>bool</span><span class=w> </span><span class=n>prevent_shutdown</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>session_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next_session_id_</span><span class=o>++</span><span class=p>;</span>
<span class=w>    </span><span class=n>channels_</span><span class=p>[</span><span class=n>session_id</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>ChannelImpl</span><span class=o>&gt;</span><span class=p>(</span><span class=n>env_</span><span class=p>,</span>
<span class=w>                                                          </span><span class=n>client_</span><span class=p>,</span>
<span class=w>                                                          </span><span class=n>getWorkerManager</span><span class=p>(),</span>
<span class=w>                                                          </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>delegate</span><span class=p>),</span>
<span class=w>                                                          </span><span class=n>getThreadHandle</span><span class=p>(),</span>
<span class=w>                                                          </span><span class=n>prevent_shutdown</span><span class=p>);</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>session_id</span><span class=p>;</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> connectFrontend新建了一个ChannelImpl对象，在新建ChannelImpl时，会初始化子线程处理的逻辑。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w> </span><span class=k>explicit</span><span class=w> </span><span class=n>ChannelImpl</span><span class=p>(</span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span>
<span class=w>                       </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>V8Inspector</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>inspector</span><span class=p>,</span>
<span class=w>                       </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>WorkerManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>worker_manager</span><span class=p>,</span>
<span class=w>                       </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSessionDelegate</span><span class=o>&gt;</span><span class=w> </span><span class=n>delegate</span><span class=p>,</span>
<span class=w>                       </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MainThreadHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>main_thread_</span><span class=p>,</span>
<span class=w>                       </span><span class=kt>bool</span><span class=w> </span><span class=n>prevent_shutdown</span><span class=p>)</span>
<span class=w>      </span><span class=o>:</span><span class=w> </span><span class=n>delegate_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>delegate</span><span class=p>)),</span><span class=w> </span><span class=n>prevent_shutdown_</span><span class=p>(</span><span class=n>prevent_shutdown</span><span class=p>),</span>
<span class=w>        </span><span class=n>retaining_context_</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>session_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inspector</span><span class=o>-&gt;</span><span class=n>connect</span><span class=p>(</span><span class=n>CONTEXT_GROUP_ID</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>StringView</span><span class=p>());</span>
<span class=w>    </span><span class=c1>// Node.js拓展命令的处理分发器</span>
<span class=w>    </span><span class=n>node_dispatcher_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>UberDispatcher</span><span class=o>&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<span class=w>    </span><span class=c1>// trace相关</span>
<span class=w>    </span><span class=n>tracing_agent_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>TracingAgent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>main_thread_</span><span class=p>);</span>
<span class=w>    </span><span class=n>tracing_agent_</span><span class=o>-&gt;</span><span class=n>Wire</span><span class=p>(</span><span class=n>node_dispatcher_</span><span class=p>.</span><span class=n>get</span><span class=p>());</span>
<span class=w>    </span><span class=c1>// 处理子线程相关</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>worker_manager</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=n>worker_agent_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>WorkerAgent</span><span class=o>&gt;</span><span class=p>(</span><span class=n>worker_manager</span><span class=p>);</span>
<span class=w>      </span><span class=n>worker_agent_</span><span class=o>-&gt;</span><span class=n>Wire</span><span class=p>(</span><span class=n>node_dispatcher_</span><span class=p>.</span><span class=n>get</span><span class=p>());</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=c1>// 处理runtime</span>
<span class=w>    </span><span class=n>runtime_agent_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>RuntimeAgent</span><span class=o>&gt;</span><span class=p>();</span>
<span class=w>    </span><span class=n>runtime_agent_</span><span class=o>-&gt;</span><span class=n>Wire</span><span class=p>(</span><span class=n>node_dispatcher_</span><span class=p>.</span><span class=n>get</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 我们这里只关注处理子线程相关的逻辑。看一下 worker_agent_-&gt;Wire。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>WorkerAgent::Wire</span><span class=p>(</span><span class=n>UberDispatcher</span><span class=o>*</span><span class=w> </span><span class=n>dispatcher</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>frontend_</span><span class=p>.</span><span class=n>reset</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>NodeWorker</span><span class=o>::</span><span class=n>Frontend</span><span class=p>(</span><span class=n>dispatcher</span><span class=o>-&gt;</span><span class=n>channel</span><span class=p>()));</span>
<span class=w>  </span><span class=n>NodeWorker</span><span class=o>::</span><span class=n>Dispatcher</span><span class=o>::</span><span class=n>wire</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>manager_</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<span class=w>  </span><span class=n>workers_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>NodeWorkers</span><span class=o>&gt;</span><span class=p>(</span><span class=n>frontend_</span><span class=p>,</span><span class=w> </span><span class=n>manager</span><span class=o>-&gt;</span><span class=n>MainThread</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 这时候的架构图如下 <img alt src="https://img-blog.csdnimg.cn/b2be97e0e6c44f69a77178e8912cccfe.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 接着看一下NodeWorker::Dispatcher::wire(dispatcher, this)的逻辑。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>Dispatcher::wire</span><span class=p>(</span><span class=n>UberDispatcher</span><span class=o>*</span><span class=w> </span><span class=n>uber</span><span class=p>,</span><span class=w> </span><span class=n>Backend</span><span class=o>*</span><span class=w> </span><span class=n>backend</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>DispatcherImpl</span><span class=o>&gt;</span><span class=w> </span><span class=n>dispatcher</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DispatcherImpl</span><span class=p>(</span><span class=n>uber</span><span class=o>-&gt;</span><span class=n>channel</span><span class=p>(),</span><span class=w> </span><span class=n>backend</span><span class=p>));</span>
<span class=w>    </span><span class=n>uber</span><span class=o>-&gt;</span><span class=n>setupRedirects</span><span class=p>(</span><span class=n>dispatcher</span><span class=o>-&gt;</span><span class=n>redirects</span><span class=p>());</span>
<span class=w>    </span><span class=n>uber</span><span class=o>-&gt;</span><span class=n>registerBackend</span><span class=p>(</span><span class=s>&quot;NodeWorker&quot;</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 首先新建了一个DispatcherImpl对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>DispatcherImpl</span><span class=p>(</span><span class=n>FrontendChannel</span><span class=o>*</span><span class=w> </span><span class=n>frontendChannel</span><span class=p>,</span><span class=w> </span><span class=n>Backend</span><span class=o>*</span><span class=w> </span><span class=n>backend</span><span class=p>)</span>
<span class=w>        </span><span class=o>:</span><span class=w> </span><span class=n>DispatcherBase</span><span class=p>(</span><span class=n>frontendChannel</span><span class=p>)</span>
<span class=w>        </span><span class=p>,</span><span class=w> </span><span class=n>m_backend</span><span class=p>(</span><span class=n>backend</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=n>m_dispatchMap</span><span class=p>[</span><span class=s>&quot;NodeWorker.sendMessageToWorker&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>DispatcherImpl</span><span class=o>::</span><span class=n>sendMessageToWorker</span><span class=p>;</span>
<span class=w>        </span><span class=n>m_dispatchMap</span><span class=p>[</span><span class=s>&quot;NodeWorker.enable&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>DispatcherImpl</span><span class=o>::</span><span class=n>enable</span><span class=p>;</span>
<span class=w>        </span><span class=n>m_dispatchMap</span><span class=p>[</span><span class=s>&quot;NodeWorker.disable&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>DispatcherImpl</span><span class=o>::</span><span class=n>disable</span><span class=p>;</span>
<span class=w>        </span><span class=n>m_dispatchMap</span><span class=p>[</span><span class=s>&quot;NodeWorker.detach&quot;</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>DispatcherImpl</span><span class=o>::</span><span class=n>detach</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 除了初始化一些字段，另外了一个kv数据结构，这个是一个路由配置，后面我们会看到它的作用。新建完DispatcherImpl后又调用了uber-&gt;registerBackend("NodeWorker", std::move(dispatcher))注册该对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>UberDispatcher::registerBackend</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>DispatcherBase</span><span class=o>&gt;</span><span class=w> </span><span class=n>dispatcher</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>m_dispatchers</span><span class=p>[</span><span class=n>name</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>dispatcher</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 这时候的架构图如下。 <img alt src="https://img-blog.csdnimg.cn/f03fc092481a48a3bb8538a2fc645340.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 我们看到这里其实是建立了一个路由体系，后面收到命令时就会根据这些路由配置进行转发，类似Node.js Express框架路由机制。这时候可以通过session的post给主线程发送NodeWorker.enable命令来开启子线程的调试。我们分析这个过程。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nx>post</span><span class=p>(</span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>params</span><span class=p>,</span><span class=w> </span><span class=nx>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=c1>// 忽略参数处理</span>
<span class=w>    </span><span class=c1>// 保存请求对应的回调</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>this</span><span class=p>[</span><span class=nx>messageCallbacksSymbol</span><span class=p>].</span><span class=nx>set</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=nx>callback</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=c1>// 调用C++的dispatch</span>
<span class=w>    </span><span class=k>this</span><span class=p>[</span><span class=nx>connectionSymbol</span><span class=p>].</span><span class=nx>dispatch</span><span class=p>(</span><span class=nx>JSONStringify</span><span class=p>(</span><span class=nx>message</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> this[connectionSymbol]对应的是JSBindingsConnection对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>Dispatch</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>FunctionCallbackInfo</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>info</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>Environment</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Environment</span><span class=o>::</span><span class=n>GetCurrent</span><span class=p>(</span><span class=n>info</span><span class=p>);</span>
<span class=w>    </span><span class=n>JSBindingsConnection</span><span class=o>*</span><span class=w> </span><span class=n>session</span><span class=p>;</span>
<span class=w>    </span><span class=n>ASSIGN_OR_RETURN_UNWRAP</span><span class=p>(</span><span class=o>&amp;</span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=n>Holder</span><span class=p>());</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>session</span><span class=o>-&gt;</span><span class=n>session_</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=n>session</span><span class=o>-&gt;</span><span class=n>session_</span><span class=o>-&gt;</span><span class=n>Dispatch</span><span class=p>(</span>
<span class=w>          </span><span class=n>ToProtocolString</span><span class=p>(</span><span class=n>env</span><span class=o>-&gt;</span><span class=n>isolate</span><span class=p>(),</span><span class=w> </span><span class=n>info</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span><span class=o>-&gt;</span><span class=n>string</span><span class=p>());</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> session_是一个SameThreadInspectorSession对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>SameThreadInspectorSession::Dispatch</span><span class=p>(</span>
<span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>v8_inspector</span><span class=o>::</span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client_</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<span class=w>  </span><span class=n>client</span><span class=o>-&gt;</span><span class=n>dispatchMessageFromFrontend</span><span class=p>(</span><span class=n>session_id_</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=nf>dispatchMessageFromFrontend</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>session_id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>channels_</span><span class=p>[</span><span class=n>session_id</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>dispatchProtocolMessage</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 最终调用了ChannelImpl的dispatchProtocolMessage。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>dispatchProtocolMessage</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>raw_message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>protocol</span><span class=o>::</span><span class=n>StringUtil</span><span class=o>::</span><span class=n>StringViewToUtf8</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>DictionaryValue</span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span>
<span class=w>        </span><span class=n>protocol</span><span class=o>::</span><span class=n>DictionaryValue</span><span class=o>::</span><span class=n>cast</span><span class=p>(</span><span class=n>protocol</span><span class=o>::</span><span class=n>StringUtil</span><span class=o>::</span><span class=n>parseMessage</span><span class=p>(</span>
<span class=w>            </span><span class=n>raw_message</span><span class=p>,</span><span class=w> </span><span class=nb>false</span><span class=p>));</span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>call_id</span><span class=p>;</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>method</span><span class=p>;</span>
<span class=w>    </span><span class=c1>// 解析命令</span>
<span class=w>    </span><span class=n>node_dispatcher_</span><span class=o>-&gt;</span><span class=n>parseCommand</span><span class=p>(</span><span class=n>value</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>call_id</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>method</span><span class=p>);</span>
<span class=w>    </span><span class=c1>// 判断命令是V8内置命令还是Node.js拓展的命令</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>v8_inspector</span><span class=o>::</span><span class=n>V8InspectorSession</span><span class=o>::</span><span class=n>canDispatchMethod</span><span class=p>(</span>
<span class=w>            </span><span class=n>Utf8ToStringView</span><span class=p>(</span><span class=n>method</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>string</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=n>session_</span><span class=o>-&gt;</span><span class=n>dispatchProtocolMessage</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=n>node_dispatcher_</span><span class=o>-&gt;</span><span class=n>dispatch</span><span class=p>(</span><span class=n>call_id</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>value</span><span class=p>),</span>
<span class=w>                                 </span><span class=n>raw_message</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 因为NodeWorker.enable是Node.js拓展的命令，所以会走到else里面的逻辑。根据路由配置找到该命令对应的处理逻辑（NodeWorker.enable以.切分，对应两级路由）。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>UberDispatcher::dispatch</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>callId</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>in_method</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>parsedMessage</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>ProtocolMessage</span><span class=o>&amp;</span><span class=w> </span><span class=n>rawMessage</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=c1>// 找到一级路由配置</span>
<span class=w>    </span><span class=n>protocol</span><span class=o>::</span><span class=n>DispatcherBase</span><span class=o>*</span><span class=w> </span><span class=n>dispatcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findDispatcher</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>DictionaryValue</span><span class=o>&gt;</span><span class=w> </span><span class=n>messageObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DictionaryValue</span><span class=o>::</span><span class=n>cast</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>parsedMessage</span><span class=p>));</span>
<span class=w>    </span><span class=c1>// 交给一级路由处理器处理</span>
<span class=w>    </span><span class=n>dispatcher</span><span class=o>-&gt;</span><span class=n>dispatch</span><span class=p>(</span><span class=n>callId</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>rawMessage</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>messageObject</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> NodeWorker.enable对应的路由处理器代码如下 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>DispatcherImpl::dispatch</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>callId</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>ProtocolMessage</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>DictionaryValue</span><span class=o>&gt;</span><span class=w> </span><span class=n>messageObject</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=c1>// 查找二级路由</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>CallHandler</span><span class=o>&gt;::</span><span class=n>iterator</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m_dispatchMap</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
<span class=w>    </span><span class=n>protocol</span><span class=o>::</span><span class=n>ErrorSupport</span><span class=w> </span><span class=n>errors</span><span class=p>;</span>
<span class=w>    </span><span class=c1>// 找到处理函数</span>
<span class=w>    </span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;*</span><span class=p>(</span><span class=n>it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>))(</span><span class=n>callId</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>messageObject</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>errors</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> dispatch继续寻找命令对应的处理函数，最终找到NodeWorker.enable命令的处理函数为DispatcherImpl::enable。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>DispatcherImpl::enable</span><span class=p>(...)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>DispatcherBase</span><span class=o>::</span><span class=n>WeakPtr</span><span class=o>&gt;</span><span class=w> </span><span class=n>weak</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>weakPtr</span><span class=p>();</span>
<span class=w>    </span><span class=n>DispatchResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m_backend</span><span class=o>-&gt;</span><span class=n>enable</span><span class=p>(...);</span>
<span class=w>    </span><span class=c1>// 返回响应给命令（类似请求/响应模式）</span>
<span class=w>    </span><span class=n>weak</span><span class=o>-&gt;</span><span class=n>get</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sendResponse</span><span class=p>(</span><span class=n>callId</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 根据架构图可以知道m_backend是WorkerAgent对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>DispatchResponse</span><span class=w> </span><span class=nf>WorkerAgent::enable</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>waitForDebuggerOnStart</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>manager_</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>AgentWorkerInspectorDelegate</span><span class=o>&gt;</span><span class=w> </span><span class=n>delegate</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AgentWorkerInspectorDelegate</span><span class=p>(</span><span class=n>workers_</span><span class=p>));</span>
<span class=w>  </span><span class=n>event_handle_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>manager</span><span class=o>-&gt;</span><span class=n>SetAutoAttach</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>delegate</span><span class=p>));</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>DispatchResponse</span><span class=o>::</span><span class=n>OK</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 继续调用WorkerManager的SetAutoAttach方法。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>WorkerManagerEventHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>WorkerManager</span><span class=o>::</span><span class=n>SetAutoAttach</span><span class=p>(</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>WorkerDelegate</span><span class=o>&gt;</span><span class=w> </span><span class=n>attach_delegate</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>++</span><span class=n>next_delegate_id_</span><span class=p>;</span>
<span class=w>  </span><span class=c1>// 保存delegate</span>
<span class=w>  </span><span class=n>delegates_</span><span class=p>[</span><span class=n>id</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>attach_delegate</span><span class=p>);</span>
<span class=w>  </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>delegate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>delegates_</span><span class=p>[</span><span class=n>id</span><span class=p>];</span>
<span class=w>  </span><span class=c1>// 通知子线程</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>children_</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>Report</span><span class=p>(</span><span class=n>delegate</span><span class=p>,</span><span class=w> </span><span class=n>worker</span><span class=p>.</span><span class=n>second</span><span class=p>,</span><span class=w> </span><span class=nb>false</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
<span class=w>  </span><span class=p>...</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> SetAutoAttach遍历子线程。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>Report</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>WorkerDelegate</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>delegate</span><span class=p>,</span>
<span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>WorkerInfo</span><span class=o>&amp;</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>waiting</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>worker_thread</span><span class=p>)</span>
<span class=w>    </span><span class=n>delegate</span><span class=o>-&gt;</span><span class=n>WorkerCreated</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>waiting</span><span class=p>,</span><span class=w> </span><span class=n>info</span><span class=p>.</span><span class=n>worker_thread</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> info是一个WorkerInfo对象，该对象是子线程初始化和主线程建立关系的数据结构。delegate是AgentWorkerInspectorDelegate对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>WorkerCreated</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>title</span><span class=p>,</span>
<span class=w>                     </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>url</span><span class=p>,</span>
<span class=w>                     </span><span class=kt>bool</span><span class=w> </span><span class=n>waiting</span><span class=p>,</span>
<span class=w>                     </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MainThreadHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>workers_</span><span class=o>-&gt;</span><span class=n>WorkerCreated</span><span class=p>(</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>waiting</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> workers_是一个NodeWorkers对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>NodeWorkers::WorkerCreated</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>title</span><span class=p>,</span>
<span class=w>                                </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>url</span><span class=p>,</span>
<span class=w>                                </span><span class=kt>bool</span><span class=w> </span><span class=n>waiting</span><span class=p>,</span>
<span class=w>                                </span><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>MainThreadHandle</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>frontend</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frontend_</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=o>++</span><span class=n>next_target_id_</span><span class=p>);</span>
<span class=w>  </span><span class=c1>// 处理数据通信的delegate</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>delegate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread_</span><span class=o>-&gt;</span><span class=n>MakeDelegateThreadSafe</span><span class=p>(</span>
<span class=w>      </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>InspectorSessionDelegate</span><span class=o>&gt;</span><span class=p>(</span>
<span class=w>          </span><span class=k>new</span><span class=w> </span><span class=n>ParentInspectorSessionDelegate</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>shared_from_this</span><span class=p>())</span>
<span class=w>      </span><span class=p>)</span>
<span class=w>  </span><span class=p>);</span>
<span class=w>  </span><span class=c1>// 建立和子线程V8 Inspector的通信通道</span>
<span class=w>  </span><span class=n>sessions_</span><span class=p>[</span><span class=n>id</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>target</span><span class=o>-&gt;</span><span class=n>Connect</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>delegate</span><span class=p>),</span><span class=w> </span><span class=nb>true</span><span class=p>);</span>
<span class=w>  </span><span class=n>frontend</span><span class=o>-&gt;</span><span class=n>attachedToWorker</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>WorkerInfo</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>),</span><span class=w> </span><span class=n>waiting</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> WorkerCreated建立了一条和子线程通信的通道，然后通知命令的发送方通道建立成功。这时候架构图如下。 <img alt src="https://img-blog.csdnimg.cn/3ecfcb9115a64a119fc0677ee7c159e9.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 接着看attachedToWorker。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>Frontend::attachedToWorker</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>protocol</span><span class=o>::</span><span class=n>NodeWorker</span><span class=o>::</span><span class=n>WorkerInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>workerInfo</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>waitingForDebugger</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>AttachedToWorkerNotification</span><span class=o>&gt;</span><span class=w> </span><span class=n>messageData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AttachedToWorkerNotification</span><span class=o>::</span><span class=n>create</span><span class=p>()</span>
<span class=w>        </span><span class=p>.</span><span class=n>setSessionId</span><span class=p>(</span><span class=n>sessionId</span><span class=p>)</span>
<span class=w>        </span><span class=p>.</span><span class=n>setWorkerInfo</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>workerInfo</span><span class=p>))</span>
<span class=w>        </span><span class=p>.</span><span class=n>setWaitingForDebugger</span><span class=p>(</span><span class=n>waitingForDebugger</span><span class=p>)</span>
<span class=w>        </span><span class=p>.</span><span class=n>build</span><span class=p>();</span>
<span class=w>    </span><span class=c1>// 触发NodeWorker.attachedToWorker</span>
<span class=w>    </span><span class=n>m_frontendChannel</span><span class=o>-&gt;</span><span class=n>sendProtocolNotification</span><span class=p>(</span><span class=n>InternalResponse</span><span class=o>::</span><span class=n>createNotification</span><span class=p>(</span><span class=s>&quot;NodeWorker.attachedToWorker&quot;</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>messageData</span><span class=p>)));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 继续看sendProtocolNotification <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendProtocolNotification</span><span class=p>(</span>
<span class=w>      </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Serializable</span><span class=o>&gt;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>sendMessageToFrontend</span><span class=p>(</span><span class=n>message</span><span class=o>-&gt;</span><span class=n>serializeToJSON</span><span class=p>());</span>
<span class=w> </span><span class=p>}</span>

<span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessageToFrontend</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>delegate_</span><span class=o>-&gt;</span><span class=n>SendMessageToFrontend</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=w> </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 这里的delegate_是一个JSBindingsSessionDelegate对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w>   </span><span class=kt>void</span><span class=w> </span><span class=nf>SendMessageToFrontend</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>v8_inspector</span><span class=o>::</span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span>
<span class=w>        </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=n>Isolate</span><span class=o>*</span><span class=w> </span><span class=n>isolate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env_</span><span class=o>-&gt;</span><span class=n>isolate</span><span class=p>();</span>
<span class=w>      </span><span class=n>HandleScope</span><span class=w> </span><span class=n>handle_scope</span><span class=p>(</span><span class=n>isolate</span><span class=p>);</span>
<span class=w>      </span><span class=n>Context</span><span class=o>::</span><span class=n>Scope</span><span class=w> </span><span class=n>context_scope</span><span class=p>(</span><span class=n>env_</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>());</span>
<span class=w>      </span><span class=n>MaybeLocal</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>v8string</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=o>::</span><span class=n>NewFromTwoByte</span><span class=p>(</span><span class=n>isolate</span><span class=p>,</span>
<span class=w>                                               </span><span class=n>message</span><span class=p>.</span><span class=n>characters16</span><span class=p>(),</span>
<span class=w>                                               </span><span class=n>NewStringType</span><span class=o>::</span><span class=n>kNormal</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=n>length</span><span class=p>()</span>
<span class=w>      </span><span class=p>);</span>
<span class=w>      </span><span class=n>Local</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>argument</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v8string</span><span class=p>.</span><span class=n>ToLocalChecked</span><span class=p>().</span><span class=n>As</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=p>();</span>
<span class=w>      </span><span class=c1>// 收到消息执行回调</span>
<span class=w>      </span><span class=n>connection_</span><span class=o>-&gt;</span><span class=n>OnMessage</span><span class=p>(</span><span class=n>argument</span><span class=p>);</span>
<span class=p>}</span>
<span class=c1>// 执行JS层回调</span>
<span class=kt>void</span><span class=w> </span><span class=nf>OnMessage</span><span class=p>(</span><span class=n>Local</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>   </span><span class=n>MakeCallback</span><span class=p>(</span><span class=n>callback_</span><span class=p>.</span><span class=n>Get</span><span class=p>(</span><span class=n>env</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>isolate</span><span class=p>()),</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>value</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> JS层回调逻辑如下。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=p>[</span><span class=nx>onMessageSymbol</span><span class=p>](</span><span class=nx>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>parsed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>JSONParse</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
<span class=w>    </span><span class=c1>// 收到的消息如果是某个请求的响应，则有个id字段记录了请求对应的id，否则则触发事件</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>parsed</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>       </span><span class=kd>const</span><span class=w> </span><span class=nx>callback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>[</span><span class=nx>messageCallbacksSymbol</span><span class=p>].</span><span class=nx>get</span><span class=p>(</span><span class=nx>parsed</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
<span class=w>       </span><span class=k>this</span><span class=p>[</span><span class=nx>messageCallbacksSymbol</span><span class=p>].</span><span class=ow>delete</span><span class=p>(</span><span class=nx>parsed</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
<span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>         </span><span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=nx>parsed</span><span class=p>.</span><span class=nx>result</span><span class=p>);</span>
<span class=w>       </span><span class=p>}</span>
<span class=w>     </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>       </span><span class=k>this</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>parsed</span><span class=p>.</span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>parsed</span><span class=p>);</span>
<span class=w>       </span><span class=k>this</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;inspectorNotification&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>parsed</span><span class=p>);</span>
<span class=w>     </span><span class=p>}</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 主线程拿到Worker Session对一个的id，后续就可以通过命令NodeWorker.sendMessageToWorker加上该id和子线程通信。大致原理如下，主线程通过自己的channel和子线程的channel进行通信，从而达到控制子线程的目的。 <img alt src="https://img-blog.csdnimg.cn/658f975ad0664dc1b08b7a59d30db786.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RIRUFOQVJLSA==,size_16,color_FFFFFF,t_70"> 我们分析一下NodeWorker.sendMessageToWorker命令的逻辑，对应处理函数为DispatcherImpl::sendMessageToWorker。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>DispatcherImpl::sendMessageToWorker</span><span class=p>(...)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>DispatcherBase</span><span class=o>::</span><span class=n>WeakPtr</span><span class=o>&gt;</span><span class=w> </span><span class=n>weak</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>weakPtr</span><span class=p>();</span>
<span class=w>    </span><span class=n>DispatchResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m_backend</span><span class=o>-&gt;</span><span class=n>sendMessageToWorker</span><span class=p>(</span><span class=n>in_message</span><span class=p>,</span><span class=w> </span><span class=n>in_sessionId</span><span class=p>);</span>
<span class=w>    </span><span class=c1>// 响应</span>
<span class=w>    </span><span class=n>weak</span><span class=o>-&gt;</span><span class=n>get</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sendResponse</span><span class=p>(</span><span class=n>callId</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span>
<span class=w>    </span><span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 继续分析m_backend-&gt;sendMessageToWorker。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>DispatchResponse</span><span class=w> </span><span class=nf>WorkerAgent::sendMessageToWorker</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>,</span>
<span class=w>                                                  </span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>sessionId</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>workers_</span><span class=o>-&gt;</span><span class=n>Receive</span><span class=p>(</span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>DispatchResponse</span><span class=o>::</span><span class=n>OK</span><span class=p>();</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=nf>NodeWorkers::Receive</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessions_</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
<span class=w>  </span><span class=n>it</span><span class=o>-&gt;</span><span class=n>second</span><span class=o>-&gt;</span><span class=n>Dispatch</span><span class=p>(</span><span class=n>Utf8ToStringView</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>string</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> sessions_对应的是和子线程的通信的数据结构CrossThreadInspectorSession。看一下该对象的Dispatch方法。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>Dispatch</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>state_</span><span class=p>.</span><span class=n>Call</span><span class=p>(</span><span class=o>&amp;</span><span class=n>MainThreadSessionState</span><span class=o>::</span><span class=n>Dispatch</span><span class=p>,</span>
<span class=w>                </span><span class=n>StringBuffer</span><span class=o>::</span><span class=n>create</span><span class=p>(</span><span class=n>message</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 再次调了MainThreadSessionState::Dispatch</p> <p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>Dispatch</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>StringBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>session_</span><span class=o>-&gt;</span><span class=n>Dispatch</span><span class=p>(</span><span class=n>message</span><span class=o>-&gt;</span><span class=n>string</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> session_是SameThreadInspectorSession对象。继续看它的Dispatch方法。</p> <p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>SameThreadInspectorSession::Dispatch</span><span class=p>(</span>
<span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>v8_inspector</span><span class=o>::</span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client_</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<span class=w>  </span><span class=n>client</span><span class=o>-&gt;</span><span class=n>dispatchMessageFromFrontend</span><span class=p>(</span><span class=n>session_id_</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=nf>dispatchMessageFromFrontend</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>session_id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>channels_</span><span class=p>[</span><span class=n>session_id</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>dispatchProtocolMessage</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 通过层层调用，最终拿到了一个合子线程通信的channel，dispatchProtocolMessage方法刚才已经分析过，该方法会根据命令做不同的处理，因为我们这里发送的是V8内置的命令，所以会交给V8 Inspector处理。当V8 Inspector处理完后，会通过ChannelImpl的sendResponse返回结果。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>sendResponse</span><span class=p>(</span>
<span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>callId</span><span class=p>,</span>
<span class=w>      </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>v8_inspector</span><span class=o>::</span><span class=n>StringBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>sendMessageToFrontend</span><span class=p>(</span><span class=n>message</span><span class=o>-&gt;</span><span class=n>string</span><span class=p>());</span>
<span class=p>}</span>

<span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessageToFrontend</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>delegate_</span><span class=o>-&gt;</span><span class=n>SendMessageToFrontend</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div></td></tr></table></div> 这里的delegate_是ParentInspectorSessionDelegate对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>SendMessageToFrontend</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>v8_inspector</span><span class=o>::</span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=n>override</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>protocol</span><span class=o>::</span><span class=n>StringUtil</span><span class=o>::</span><span class=n>StringViewToUtf8</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
<span class=w>  </span><span class=n>workers_</span><span class=o>-&gt;</span><span class=n>Send</span><span class=p>(</span><span class=n>id_</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=nf>NodeWorkers::Send</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>auto</span><span class=w> </span><span class=n>frontend</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frontend_</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>frontend</span><span class=p>)</span>
<span class=w>    </span><span class=n>frontend</span><span class=o>-&gt;</span><span class=n>receivedMessageFromWorker</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=nf>Frontend::receivedMessageFromWorker</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>String</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>ReceivedMessageFromWorkerNotification</span><span class=o>&gt;</span><span class=w> </span><span class=n>messageData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ReceivedMessageFromWorkerNotification</span><span class=o>::</span><span class=n>create</span><span class=p>()</span>
<span class=w>        </span><span class=p>.</span><span class=n>setSessionId</span><span class=p>(</span><span class=n>sessionId</span><span class=p>)</span>
<span class=w>        </span><span class=p>.</span><span class=n>setMessage</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
<span class=w>        </span><span class=p>.</span><span class=n>build</span><span class=p>();</span>
<span class=w> </span><span class=c1>// 触发NodeWorker.receivedMessageFromWorker       </span>
<span class=w>    </span><span class=n>m_frontendChannel</span><span class=o>-&gt;</span><span class=n>sendProtocolNotification</span><span class=p>(</span><span class=n>InternalResponse</span><span class=o>::</span><span class=n>createNotification</span><span class=p>(</span><span class=s>&quot;NodeWorker.receivedMessageFromWorker&quot;</span><span class=p>,</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>messageData</span><span class=p>)));</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> m_frontendChannel是主线程的ChannelImpl对象。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>sendProtocolNotification</span><span class=p>(</span>
<span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>Serializable</span><span class=o>&gt;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=k>override</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>sendMessageToFrontend</span><span class=p>(</span><span class=n>message</span><span class=o>-&gt;</span><span class=n>serializeToJSON</span><span class=p>());</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=nf>sendMessageToFrontend</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>StringView</span><span class=o>&amp;</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>delegate_</span><span class=o>-&gt;</span><span class=n>SendMessageToFrontend</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> delegate_是C++层传入的JSBindingsSessionDelegate对象。最终通过JSBindingsSessionDelegate对象回调JS层，之前已经分析过就不再赘述。至此，主线程就具备了控制子线程的能力，但是控制方式有很多种。</p> <h2 id=21-v8>2.1 使用通用的V8命令<a class=headerlink href=#21-v8 title="Permanent link">&para;</a></h2> <p>通过下面代码收集子线程的CPU Profile信息。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Worker</span><span class=p>,</span><span class=w> </span><span class=nx>workerData</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;worker_threads&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Session</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;inspector&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Session</span><span class=p>();</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
<span class=kd>let</span><span class=w> </span><span class=nx>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>1</span><span class=p>;</span>
<span class=kd>function</span><span class=w> </span><span class=nx>post</span><span class=p>(</span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>params</span><span class=p>,</span><span class=w> </span><span class=nx>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;NodeWorker.sendMessageToWorker&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>sessionId</span><span class=p>,</span>
<span class=w>        </span><span class=nx>message</span><span class=o>:</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=nx>id</span><span class=o>++</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=p>})</span>
<span class=w>    </span><span class=p>},</span><span class=w> </span><span class=nx>callback</span><span class=p>);</span>
<span class=p>}</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;NodeWorker.attachedToWorker&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>post</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Profiler.enable&#39;</span><span class=p>);</span>
<span class=w>    </span><span class=nx>post</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Profiler.start&#39;</span><span class=p>);</span>
<span class=w>    </span><span class=c1>// 收集一段时间后提交停止收集命令</span>
<span class=w>    </span><span class=nx>setTimeout</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>post</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>sessionId</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Profiler.stop&#39;</span><span class=p>);</span>
<span class=w>    </span><span class=p>},</span><span class=w> </span><span class=mf>10000</span><span class=p>)</span>
<span class=p>});</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;NodeWorker.receivedMessageFromWorker&#39;</span><span class=p>,</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>params</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>message</span><span class=w> </span><span class=p>}})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
<span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
<span class=p>});</span>

<span class=kd>const</span><span class=w> </span><span class=nx>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;./httpServer.js&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=nx>workerData</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=mf>80</span><span class=p>}});</span><span class=w> </span>
<span class=nx>worker</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;online&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&quot;NodeWorker.enable&quot;</span><span class=p>,{</span><span class=nx>waitForDebuggerOnStart</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>},</span><span class=w>  </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NodeWorker.enable&quot;</span><span class=p>);});</span>
<span class=p>});</span>
<span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=mf>100000</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> 通过这种方式可以通过命令控制子线程的调试和数据收集。</p> <h2 id=22>2.2 在子线程中动态执行脚本<a class=headerlink href=#22 title="Permanent link">&para;</a></h2> <p>可以通过执行脚本开启子线程的WebSocket服务，像调试主线程一样。 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Worker</span><span class=p>,</span><span class=w> </span><span class=nx>workerData</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;worker_threads&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Session</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;inspector&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Session</span><span class=p>();</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
<span class=kd>let</span><span class=w> </span><span class=nx>workerSessionId</span><span class=p>;</span>
<span class=kd>let</span><span class=w> </span><span class=nx>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>1</span><span class=p>;</span>
<span class=kd>function</span><span class=w> </span><span class=nx>post</span><span class=p>(</span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;NodeWorker.sendMessageToWorker&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=nx>workerSessionId</span><span class=p>,</span>
<span class=w>        </span><span class=nx>message</span><span class=o>:</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=nx>id</span><span class=o>++</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=p>})</span>
<span class=w>    </span><span class=p>});</span>
<span class=p>}</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;NodeWorker.receivedMessageFromWorker&#39;</span><span class=p>,</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>params</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>message</span><span class=w> </span><span class=p>}})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
<span class=w>    </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>session</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;NodeWorker.attachedToWorker&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>workerSessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>data</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>sessionId</span><span class=p>;</span>
<span class=w>    </span><span class=nx>post</span><span class=p>(</span><span class=s2>&quot;Runtime.evaluate&quot;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>includeCommandLineAPI</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span>
<span class=w>        </span><span class=nx>expression</span><span class=o>:</span><span class=w> </span><span class=sb>`const inspector = process.binding(&#39;inspector&#39;);</span>
<span class=sb>                    inspector.open();</span>
<span class=sb>                    inspector.url();</span>
<span class=sb>                    `</span>
<span class=w>        </span><span class=p>}</span><span class=w> </span>
<span class=w>    </span><span class=p>);</span>
<span class=p>});</span>

<span class=kd>const</span><span class=w> </span><span class=nx>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;./httpServer.js&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=nx>workerData</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=mf>80</span><span class=p>}});</span><span class=w> </span>
<span class=nx>worker</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;online&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&quot;NodeWorker.enable&quot;</span><span class=p>,{</span><span class=nx>waitForDebuggerOnStart</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>},</span><span class=w>  </span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=nx>err</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;NodeWorker.enable&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>);});</span>
<span class=p>});</span>

<span class=nx>setInterval</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=mf>100000</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> 执行上面的代码就拿到以下输出 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=p>{</span>
<span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=mf>1</span><span class=p>,</span>
<span class=w>  </span><span class=nx>result</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>result</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nx>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;string&#39;</span><span class=p>,</span>
<span class=w>      </span><span class=nx>value</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;ws://127.0.0.1:9229/c0ca16c8-55aa-4651-9776-fca1b27fc718&#39;</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> 通过该地址，客户端就可以对子线程进行调试了。上面代码里使用process.binding而不是require加载inspector，因为刚才通过NodeWorker.enable命令为子线程创建了一个到子线程Inspector的channel，而JS模块里判断如果channel非空则报错Inspector已经打开。所以这里需要绕过这个限制，直接加载C++模块开启WebSocket服务器。</p> <h1 id=3>3 子线程调试主线程<a class=headerlink href=#3 title="Permanent link">&para;</a></h1> <p>不仅可以通过主线程调试子线程，还可以通过子线程调试主线程。Node.js在子线程暴露了connectToMainThread方法连接到主线程的Inspector（只能在work_threads中使用），实现的原理和之前分析的类似，主要是子线程连接到主线程的V8 Inspector，通过和该Inspector完成对主线程的控制。看下面一个例子。 主线程代码 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Worker</span><span class=p>,</span><span class=w> </span><span class=nx>workerData</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;worker_threads&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=nx>http</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>

<span class=kd>const</span><span class=w> </span><span class=nx>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;./worker.js&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=nx>workerData</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=mf>80</span><span class=p>}});</span>

<span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;main&#39;</span><span class=p>);</span>
<span class=p>}).</span><span class=nx>listen</span><span class=p>(</span><span class=mf>8000</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> worker.js代码如下 <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kd>const</span><span class=w> </span><span class=nx>fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>workerData</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>port</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;worker_threads&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Session</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;inspector&#39;</span><span class=p>);</span>
<span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Session</span><span class=p>();</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>connectToMainThread</span><span class=p>();</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;Profiler.enable&#39;</span><span class=p>);</span>
<span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;Profiler.start&#39;</span><span class=p>);</span>
<span class=nx>setTimeout</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;Profiler.stop&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>profile</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>            </span><span class=nx>fs</span><span class=p>.</span><span class=nx>writeFileSync</span><span class=p>(</span><span class=s1>&#39;./profile.cpuprofile&#39;</span><span class=p>,</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>profile</span><span class=p>));</span>
<span class=w>        </span><span class=p>}</span>
<span class=w>    </span><span class=p>});</span>
<span class=p>},</span><span class=w> </span><span class=mf>5000</span><span class=p>)</span>
</code></pre></div></td></tr></table></div></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021 theanarkh </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/theanarkh target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://www.zhihu.com/people/theanarkh target=_blank rel=noopener title=www.zhihu.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../assets/javascripts/bundle.83f73b43.min.js></script> <script src=../extra/image.js defer></script> </body> </html>